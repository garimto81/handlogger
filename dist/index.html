<!-- index  — Poker Hand Logger — 버전은 VERSION 상수 참조 -->
<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"/>
<title>Poker Hand Logger</title>
<script>
/* ===== 버전 관리 (code.gs와 동기화) ===== */
const VERSION = 'v2.3';
const VERSION_DATE = '2025-10-06';
const VERSION_FULL = `${VERSION} (${VERSION_DATE})`;
const VERSION_NOTES = 'Type 시트 통합 (ROSTER_SPREADSHEET 제거)';
</script>
<style>
:root{font-size:28px;--bg:#0b0d12;--panel:#101522;--line:#1f2435;--muted:#9aa3b2;--acc:#2a6fff;--text:#e7eaf0}
*{box-sizing:border-box}
body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial}
header,footer{padding:12px 14px;background:#0f1320;border-bottom:1px solid #222}
.wrap{display:flex;flex-direction:column;gap:12px;padding:12px}
.panel{background:var(--panel);border:1px solid var(--line);border-radius:14px;padding:14px}
h3{margin:0 0 10px;color:#a9b8ff;font-size:1rem}
label{font-size:.8rem;color:var(--muted)}
select,input,button{background:#0f1320;color:var(--text);border:1px solid #2a3249;border-radius:12px;padding:12px;font-size:1rem}
.row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
.grid{display:grid;gap:10px}.g2{grid-template-columns:1fr 1fr}
.pill{display:inline-flex;padding:8px 10px;border:1px solid #2a3249;border-radius:999px;cursor:pointer}
.pill.active{background:#223266;border-color:var(--acc)}
.seatCard{padding:10px;border:1px dashed #2a3249;border-radius:12px}
.small{font-size:.8rem}.muted{color:var(--muted)}
.hidden{display:none !important}
.boardWrap{display:grid;grid-template-columns:repeat(4,1fr);gap:6px;max-height:38vh;overflow:auto}
.suitCol{display:grid;grid-template-rows:repeat(13,1fr);gap:6px}
.card{height:54px;border-radius:10px;border:1px solid #2a3249;display:flex;justify-content:center;align-items:center;background:#0f1320;cursor:pointer}
.card.sel{outline:2px solid var(--acc)}
.actionDock{position:sticky;bottom:0;left:0;right:0;background:#0c1120;border-top:1px solid #20263a;padding:12px;z-index:5}
.actionDock .pad{display:grid;grid-template-columns:repeat(2,1fr);gap:10px}
.actionDock button{height:66px;font-weight:700}
.btnPrimary{background:var(--acc);border-color:var(--acc)}
.holeBadge{display:inline-flex;gap:6px}
.badge{padding:6px 8px;border:1px solid #2a3249;border-radius:999px}
.badge.click{cursor:pointer}
#overlay{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center;z-index:20}
#overlay .box{width:min(680px,94vw);max-height:80vh;overflow:auto;background:#0f1320;border:1px solid #2a3249;border-radius:14px;padding:12px}
.logbox{max-height:22vh;overflow:auto;border:1px solid #1b2133;border-radius:10px;padding:8px;background:#0e1320}

/* === Review 배지 & 보드 === */
.badgeRow{display:flex;flex-direction:column;gap:8px}
.cardBadge{display:inline-flex;align-items:center;justify-content:center;min-width:68px;height:68px;padding:0 12px;border-radius:12px;border:6px solid #2a3249;background:#ffffff;font-weight:900;font-size:1.25rem}
.cb-s{border-color:#111111;color:#111111} /* spade = black */
.cb-h{border-color:#ef4444;color:#ef4444} /* heart = red */
.cb-d{border-color:#3b82f6;color:#3b82f6} /* diamond = blue*/
.cb-c{border-color:#22c55e;color:#22c55e} /* club = green */
.actBadge{display:inline-flex;align-items:center;gap:8px;padding:10px 14px;border-radius:12px;border:3px solid;font-weight:800;width:fit-content}
.act-chk{border-color:#22c55e;background:rgba(34,197,94,.15);color:#eafff0}
.act-call{border-color:#22c55e;background:rgba(34,197,94,.15);color:#eafff0}
.act-bet{border-color:#ef4444;background:rgba(239,68,68,.15);color:#ffe3e3}
.act-raise{border-color:#ef4444;background:rgba(239,68,68,.15);color:#ffe3e3}
.act-fold{border-color:#3b82f6;background:rgba(59,130,246,.15);color:#e6f0ff}
.act-allin{border-color:#b91c1c;background:rgba(185,28,28,.2);color:#ffe5e5}
.streetTitle{margin:10px 0 4px;font-weight:900;color:#a9b8ff}
.playerName{font-weight:800}

/* 설정 토글 */
.settings{display:flex;gap:8px;align-items:center}
.settings input{min-width:220px}

/* === Review 2-Panel 레이아웃 (v1.2.0) === */
#panelReview{display:flex;flex-direction:column;gap:12px}
#reviewContainer{display:flex;gap:12px;width:100%}
#list{flex:0 0 40%;max-height:75vh;overflow-y:auto;border:1px solid var(--line);border-radius:10px;padding:8px;background:#0e1320}
#detail{flex:1;max-height:75vh;overflow-y:auto;border:1px solid var(--line);border-radius:10px;padding:12px;background:#0e1320}
.seatCard.selected{border:2px solid var(--acc);background:rgba(42,111,255,.1)}

/* === Review 상세 디자인 (v1.2.1) === */
.potHeader{display:flex;justify-content:space-between;align-items:center;padding:8px 0;border-bottom:1px solid var(--line);margin-bottom:8px}
.boardSection{margin:12px 0}
.playerSection{margin:12px 0}
.playerRow{display:grid;grid-template-columns:2fr 3fr 1fr;gap:12px;padding:6px 0;align-items:center}
.playerName{font-weight:800}
.playerHole{display:flex;gap:4px}
.playerStack{text-align:right;color:var(--muted)}
.sectionDivider{height:1px;background:var(--line);margin:8px 0}
.potFooter{text-align:center;padding:12px;font-weight:800;color:var(--acc)}
.cardBadgeSmall{display:inline-flex;align-items:center;justify-content:center;min-width:32px;height:32px;padding:0 6px;border-radius:6px;border:3px solid;font-size:0.8rem;font-weight:800}
.boardSmall{display:flex;gap:4px;margin-top:4px;flex-wrap:wrap}

/* ========== Tracker CSS ========== */
#panelTracker {

  :root{
    font-size:clamp(18px,5.5vw,26px);
    --sp-xs:clamp(4px,1vw,8px);
    --sp-sm:clamp(8px,2vw,12px);
    --sp-md:clamp(10px,2.5vw,16px);
    --sp-lg:clamp(14px,3.5vw,24px);
    --bg:#0b0d12;--panel:#101522;--line:#1f2435;--muted:#9aa3b2;--acc:#2a6fff;--text:#e7eaf0;--green:#22c55e;--red:#ef4444
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;overflow:hidden}
  body{background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;display:flex;flex-direction:column}
  header{padding:var(--sp-sm) var(--sp-md);background:#0f1320;border-bottom:1px solid #222;display:flex;justify-content:space-between;align-items:center;flex-shrink:0}
  .wrap{padding:var(--sp-sm);flex:1;overflow-y:auto;-webkit-overflow-scrolling:touch}
  h2{margin:0 0 var(--sp-md);color:#a9b8ff;font-size:1.1rem;padding:0 var(--sp-xs)}
  .small{font-size:.8rem}.muted{color:var(--muted)}
  .hidden{display:none !important}
  
  /* === Key Player Card === */
  .keyPlayerCard{background:var(--panel);border:1px solid var(--line);border-radius:var(--sp-md);padding:var(--sp-md);margin-bottom:var(--sp-sm)}
  .cardHeader{display:flex;gap:var(--sp-xs);align-items:center;margin-bottom:var(--sp-xs)}
  .tableLabel{background:#223266;padding:var(--sp-xs) var(--sp-sm);border-radius:var(--sp-xs);font-size:.75rem;font-weight:700}
  .playerName{font-size:.85rem;font-weight:700}
  .flag{font-size:.9rem}
  .chipRow{display:flex;gap:var(--sp-xs);align-items:center;margin-bottom:var(--sp-sm)}
  .chips{font-size:1rem;font-weight:800;cursor:pointer;color:var(--acc);text-decoration:underline}
  .chipChange{font-size:.75rem;font-weight:700}
  .chipChange.up{color:var(--green)}
  .chipChange.down{color:var(--red)}
  .chipChange.same{color:var(--muted)}
  .manageBtn{background:#0f1320;color:var(--text);border:1px solid #2a3249;border-radius:var(--sp-sm);padding:var(--sp-sm) var(--sp-md);font-size:.8rem;width:100%;cursor:pointer}
  
  /* === Table View === */
  .backBtn{background:transparent;border:none;color:var(--acc);font-size:.9rem;cursor:pointer;padding:var(--sp-sm);margin-bottom:var(--sp-sm)}
  .playerRow{background:var(--panel);border:1px solid var(--line);border-radius:var(--sp-sm);padding:var(--sp-sm) var(--sp-md);margin-bottom:var(--sp-sm);display:flex;align-items:center;gap:var(--sp-sm)}
  .seat{font-weight:800;font-size:.85rem;min-width:28px}
  .name{flex:1;font-weight:700;font-size:.85rem}
  .keyStar{color:#fbbf24}
  .emptySeat{flex:1;color:var(--muted);font-style:italic}
  .addBtn{background:#223266;border:1px solid var(--acc);color:var(--acc);border-radius:var(--sp-sm);padding:var(--sp-xs) var(--sp-md);font-size:.8rem;cursor:pointer}
  .deleteBtn{background:transparent;border:none;font-size:1.1rem;cursor:pointer;padding:var(--sp-xs) var(--sp-sm)}
  
  /* === Overlay === */
  #overlay{position:fixed;inset:0;background:rgba(0,0,0,.75);display:none;align-items:center;justify-content:center;z-index:100}
  #overlay.show{display:flex}
  .overlayBox{width:min(440px,90vw);background:#0f1320;border:1px solid #2a3249;border-radius:var(--sp-md);padding:var(--sp-lg)}
  .overlayTitle{font-size:1rem;font-weight:700;margin-bottom:var(--sp-md);color:#a9b8ff}
  .overlayInput{width:100%;background:#0b0d12;color:var(--text);border:1px solid #2a3249;border-radius:var(--sp-sm);padding:var(--sp-md);font-size:1rem;margin-bottom:var(--sp-md)}
  .overlayInput:focus{outline:2px solid var(--acc)}
  .overlayActions{display:flex;gap:var(--sp-md);margin-top:var(--sp-md)}
  .btnCancel{background:#2a3249;border:1px solid #2a3249;color:var(--text);border-radius:var(--sp-sm);padding:var(--sp-md);font-size:.95rem;flex:1;cursor:pointer}
  .btnConfirm{background:var(--acc);border:1px solid var(--acc);color:#fff;border-radius:var(--sp-sm);padding:var(--sp-md);font-size:.95rem;flex:1;cursor:pointer;font-weight:700}
  
  /* === Loading === */
  .loading{text-align:center;padding:var(--sp-lg);color:var(--muted)}
  .error{background:#b91c1c;color:#ffe5e5;padding:var(--sp-md);border-radius:var(--sp-sm);margin-bottom:var(--sp-md);font-size:.9rem}
  
}

/* ========== SoftSender CSS ========== */
#panelSoftsender {

  :root{
    --bg:#0E0F10; --panel:#141516; --panel2:#1B1C1D; --border:#2A2B2C;
    --txt:#F2F3F5; --sub:#B9C0CC; --accent:#19D27C; --err:#FF6464;
    --radius:16px; --pad:18px;
  
    --fs-base:24px; --fs-sm:19px; --fs-h:32px; --touch:64px;
  }
  /* 모바일 터치 최적화: 300ms 지연 제거 */
  *{touch-action:manipulation; -webkit-tap-highlight-color:transparent;}
  button,.btn,.tabs button{user-select:none;}
  
  html,body{background:var(--bg); color:var(--txt); font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; font-size:var(--fs-base); margin:0;}
  .wrap{max-width:980px;margin:0 auto;padding:14px 14px 120px;}
  header{display:flex;justify-content:space-between;align-items:flex-end;margin:8px 0 12px;}
  h1{font-size:var(--fs-h);margin:8px 0;}
  #status{font-size:var(--fs-sm);color:#9fe7cc;}
  
  .field{margin:14px 0;}
  label{display:block;margin:6px 0 8px;color:var(--sub);font-size:var(--fs-sm);}
  input,select,textarea{
    width:100%; background:var(--panel); color:var(--txt); border:1px solid var(--border);
    border-radius:var(--radius); padding:0 var(--pad); height:var(--touch); box-sizing:border-box; font-size:1em;
  }
  textarea{min-height: calc(var(--touch)*2.3); padding:14px var(--pad); white-space:pre-wrap; line-height:1.25;}
  
  .row{display:grid; gap:14px;}
  .row.two{grid-template-columns:1fr 1fr;}
  .row.three{grid-template-columns:1fr 1fr 1fr;}
  
  .tabs{display:flex;gap:10px;margin:14px 0;}
  .tabs button{flex:1;height:var(--touch);border-radius:var(--radius);border:1px solid var(--border);background:var(--panel2);color:#0b1d14;background:linear-gradient(0deg,#19D27C,#19D27C);opacity:.85;}
  .tabs button.active{opacity:1;}
  .btn{height:var(--touch);padding:0 18px;border-radius:var(--radius);border:1px solid var(--border);font-weight:800;font-size:1em;}
  .btn.primary{background:var(--accent);color:#0b1d14;}
  .btn.ghost{background:var(--panel2);color:#fff;}
  
  /* 즉각 터치 피드백 (50ms) */
  button:active,.btn:active,.tabs button:active{transform:scale(0.97);opacity:0.8;transition:transform 0.05s,opacity 0.05s;}
  input:focus,select:focus,textarea:focus{border-color:var(--accent);outline:none;transition:border-color 0.1s;}
  
  .muted{color:var(--sub);font-size:var(--fs-sm);}
  #toast{position:fixed;left:50%;transform:translateX(-50%);bottom:22px;background:var(--panel2);color:#fff;padding:12px 16px;border-radius:14px;border:1px solid var(--border);opacity:0;pointer-events:none;z-index:10;}
  #toast.show{opacity:1;transition:opacity .15s;}
  #toast.err{border-color:var(--err);color:#ffdada;}
  
  .lb-row{display:grid; grid-template-columns: 1.6fr 1fr; gap:10px; align-items:center;}
  .lb-list{display:flex; flex-direction:column; gap:10px;}
  
  /* 배치 빌더 최적화 */
  details > summary {
    list-style: none;
  }
  details > summary::-webkit-details-marker {
    display: none;
  }
  details[open] > summary {
    background: var(--panel2) !important;
  }
  
    
}
</style>
</head>
<body>
<header class="row" style="justify-content:space-between">
  <div><strong>Poker Hand Logger</strong><span class="muted small" id="versionTag"> · 모바일 최적화 · 기여액 기반 · v2.4.0</span></div>
  <div class="row">
    <button id="modeRecord" type="button" class="btnPrimary">Record</button>
    <button id="modeReview" type="button">Review</button>
    <button id="modeTracker" type="button">Tracker</button> <button id="modeSoftSender" type="button">SoftSender</button> <button id="modeSettings" type="button">⚙️</button>
  </div>
</header>

<div class="wrap">
  <div class="panel" id="panelRecord">
    <h3>Record</h3>

    <div class="grid g2">
      <div><label>테이블</label><select id="tableSel"></select></div>
      <div><label>핸드 No.</label><input id="handNo" type="number" placeholder="자동부여(선택)"/></div>
      <div><label>Big Blind (원)</label><input id="bbInput" type="number" inputmode="numeric" placeholder="예: 1000" style="width:100%"/></div>
      <div>
        <label>시작 스트릿(고정)</label>
        <select id="streetStart">
          <option value="PREFLOP">Preflop</option>
          <option value="FLOP">Flop</option>
          <option value="TURN">Turn</option>
          <option value="RIVER">River</option>
        </select>
      </div>
      <div><label>BTN 좌석</label><select id="btnSeat"></select></div>
      <div style="grid-column:1/-1"><label>선 누적 팟(pre_pot, 선택)</label><input type="number" id="prePot" placeholder="예: 12500" style="width:100%"/></div>
    </div>

    <div style="margin-top:10px">
      <label>참여 좌석 선택(비참여 제외)</label>
      <div id="seatsRow" class="row"></div>
    </div>

    <div id="stackGrid" class="grid" style="grid-template-columns:1fr; margin-top:10px"></div>

    <div class="panel" style="margin-top:10px;background:#0e1322">
      <div class="row small">
        <b>보드(카드 토글)</b><span class="muted"> · A→2 / ♠→♥→♦→♣ · 재탭 해제 · 5장까지</span>
        <span class="muted">· 현재 스트릿: <b id="curStreetTag">-</b></span>
      </div>
      <div id="boardRowRecord" class="boardWrap" style="margin-top:6px"></div>
    </div>

    <div class="panel" style="margin-top:10px;background:#0e1322">
      <div class="row small">
        <div>현재 차례: <b id="turnSeat">-</b></div>
        <div>· toCall: <b id="toCall">0</b> · pot: <b id="pot">0</b></div>
      </div>
      <div id="actionFeed" class="logbox small"></div>
    </div>

    <div class="actionDock">
      <div class="pad" id="actionPad"></div>
      <div class="row" style="margin-top:8px; width:100%">
        <button id="undoBtn" type="button">Undo</button>
        <button id="newHandBtn" type="button">새 핸드</button>
        <button id="commitBtn" type="button" class="btnPrimary" style="flex:1">데이터 전송(커밋)</button>
        <span id="commitMsg" class="small muted"></span>
      </div>
    </div>
  </div>

  <div class="panel hidden" id="panelReview">
    <h3>Review</h3>
    <div class="row">
      <button id="refreshList" type="button">새로고침</button>
      <span id="listInfo" class="small muted"></span>
    </div>
    <div id="reviewContainer">
      <div id="list"></div>
      <div id="detail" class="small">
        <div id="detailContent"></div>
        <div id="virtualBtnContainer" class="hidden" style="margin-top:20px;padding-top:20px;border-top:1px solid #2a3441">
          <div class="row">
            <button id="pushVirtualBtn" type="button" class="btnPrimary" style="flex:1">VIRTUAL 시트 전송</button>
          </div>
          <div id="virtualMsg" class="small muted" style="margin-top:8px"></div>
        </div>
      </div>
    </div>
  </div>

  <div class="panel hidden" id="panelTracker">

<header>
  <div><strong>🎯 Tracker</strong><span class="muted small"> v1.4</span></div>
</header>

<div class="wrap">
  <!-- Key Player View -->
  <div id="viewKeyPlayers">
    <h2>Key Players (<span id="keyCount">0</span>)</h2>
    <div id="keyPlayerList" class="loading">로딩 중...</div>
  </div>

  <!-- Table View -->
  <div id="viewTable" class="hidden">
    <button class="backBtn" onclick="showKeyPlayerView()">← Back</button>
    <h2 id="tableTitle">T##</h2>
    <div id="tablePlayerList"></div>
  </div>
</div>

<!-- Overlay -->
<div id="overlay">
  <div class="overlayBox">
    <div id="overlayContent"></div>
  </div>
</div>

<script>
/* ===== State ===== */
let currentView = 'key'; // 'key' | 'table'
let currentTableId = null;
let keyPlayers = [];

/* ===== Init ===== */
window.onload = () => {
  loadKeyPlayers();
};

/* ===== View Switching ===== */
function showKeyPlayerView() {
  document.getElementById('viewKeyPlayers').classList.remove('hidden');
  document.getElementById('viewTable').classList.add('hidden');
  currentView = 'key';
  currentTableId = null;
}

function showTableView(tableId) {
  document.getElementById('viewKeyPlayers').classList.add('hidden');
  document.getElementById('viewTable').classList.remove('hidden');
  document.getElementById('tableTitle').textContent = tableId;
  currentView = 'table';
  currentTableId = tableId;
  loadTablePlayers(tableId);
}

/* ===== Key Player View ===== */
function loadKeyPlayers() {
  const list = document.getElementById('keyPlayerList');
  list.innerHTML = '<div class="loading">로딩 중...</div>';

  google.script.run
    .withSuccessHandler(players => {
      keyPlayers = players;
      renderKeyPlayers(players);
    })
    .withFailureHandler(err => {
      list.innerHTML = `<div class="error">에러: ${err.message}</div>`;
    })
    .getKeyPlayers();
}

function renderKeyPlayers(players) {
  const list = document.getElementById('keyPlayerList');
  const count = document.getElementById('keyCount');

  if (players.length === 0) {
    list.innerHTML = '<div class="muted small">키 플레이어가 없습니다.</div>';
    count.textContent = '0';
    return;
  }

  list.innerHTML = '';
  count.textContent = players.length;

  players.forEach(p => {
    const card = document.createElement('div');
    card.className = 'keyPlayerCard';

    const chipChange = getChipChange(p.tableNo, p.seatNo, p.chips);
    const changeHTML = chipChange.amount !== 0
      ? `<span class="chipChange ${chipChange.direction}">${chipChange.text}</span>`
      : '';

    card.innerHTML = `
      <div class="cardHeader">
        <span class="tableLabel">${p.tableNo}</span>
        <span class="playerName">${p.player} (${p.seatNo})</span>
        <span class="flag">${getFlag(p.nation)}</span>
      </div>
      <div class="chipRow">
        <span class="chips" onclick="editChips('${p.tableNo}', '${p.seatNo}', ${p.chips}, '${p.player}')">${formatChips(p.chips)}</span>
        ${changeHTML}
      </div>
      <button class="manageBtn" onclick="showTableView('${p.tableNo}')">${p.tableNo} 관리</button>
    `;

    list.appendChild(card);
  });
}

/* ===== Table View ===== */
function loadTablePlayers(tableId) {
  const list = document.getElementById('tablePlayerList');
  list.innerHTML = '<div class="loading">로딩 중...</div>';

  google.script.run
    .withSuccessHandler(players => {
      renderTablePlayers(tableId, players);
    })
    .withFailureHandler(err => {
      list.innerHTML = `<div class="error">에러: ${err.message}</div>`;
    })
    .getTablePlayers(tableId);
}

function renderTablePlayers(tableId, players) {
  const list = document.getElementById('tablePlayerList');
  list.innerHTML = '';

  players.forEach(p => {
    const row = document.createElement('div');
    row.className = 'playerRow';

    if (p.empty) {
      row.innerHTML = `
        <span class="seat">${p.seatNo}</span>
        <span class="emptySeat">(빈 좌석)</span>
        <button class="addBtn" onclick="addPlayerPrompt('${tableId}', '${p.seatNo}')">[+]</button>
      `;
    } else {
      const keyStar = p.keyplayer ? '<span class="keyStar">⭐</span>' : '';
      row.innerHTML = `
        <span class="seat">${p.seatNo}</span>
        <span class="name">${p.player}${keyStar}</span>
        <span class="flag">${getFlag(p.nation)}</span>
        <span class="chips" onclick="editChips('${tableId}', '${p.seatNo}', ${p.chips}, '${p.player}')">${formatChips(p.chips)}</span>
        <button class="deleteBtn" onclick="deletePlayerConfirm('${tableId}', '${p.seatNo}', '${p.player}')">🗑️</button>
      `;
    }

    list.appendChild(row);
  });
}

/* ===== Edit Chips ===== */
function editChips(tableId, seatNo, currentChips, playerName) {
  const overlay = document.getElementById('overlay');
  const content = document.getElementById('overlayContent');

  content.innerHTML = `
    <div class="overlayTitle">${seatNo} ${playerName} 칩 수정</div>
    <div class="muted small">현재: ${formatChips(currentChips)}</div>
    <input type="text" id="chipInput" class="overlayInput" placeholder="예: 750000 또는 750k" autocomplete="off" inputmode="decimal">
    <div class="overlayActions">
      <button class="btnCancel" onclick="closeOverlay()">취소</button>
      <button class="btnConfirm" onclick="confirmEditChips('${tableId}', '${seatNo}', ${currentChips})">확인</button>
    </div>
  `;

  overlay.classList.add('show');
  setTimeout(() => document.getElementById('chipInput').focus(), 100);
}

function confirmEditChips(tableId, seatNo, oldChips) {
  const input = document.getElementById('chipInput').value.trim();
  if (!input) {
    alert('칩을 입력하세요.');
    return;
  }

  const newChips = parseChips(input);
  if (newChips === null || newChips < 0) {
    alert('올바른 숫자를 입력하세요 (예: 750000 또는 750k)');
    return;
  }

  closeOverlay();
  showLoading();

  google.script.run
    .withSuccessHandler(() => {
      saveChipHistory(tableId, seatNo, newChips);
      if (currentView === 'key') {
        loadKeyPlayers();
      } else {
        loadTablePlayers(currentTableId);
      }
    })
    .withFailureHandler(err => {
      alert(`에러: ${err.message}`);
      hideLoading();
    })
    .updatePlayerChips(tableId, seatNo, newChips);
}

/* ===== Add Player ===== */
function addPlayerPrompt(tableId, seatNo) {
  const overlay = document.getElementById('overlay');
  const content = document.getElementById('overlayContent');

  content.innerHTML = `
    <div class="overlayTitle">${seatNo} 플레이어 추가</div>
    <input type="text" id="nameInput" class="overlayInput" placeholder="이름" autocomplete="off">
    <select id="nationInput" class="overlayInput">
      <option value="KR">🇰🇷 KR</option>
      <option value="US">🇺🇸 US</option>
      <option value="JP">🇯🇵 JP</option>
      <option value="CN">🇨🇳 CN</option>
      <option value="GB">🇬🇧 GB</option>
      <option value="FR">🇫🇷 FR</option>
      <option value="DE">🇩🇪 DE</option>
      <option value="CA">🇨🇦 CA</option>
      <option value="AU">🇦🇺 AU</option>
      <option value="TW">🇹🇼 TW</option>
    </select>
    <input type="text" id="chipsInput" class="overlayInput" placeholder="칩 (예: 280000 또는 280k)" autocomplete="off" inputmode="decimal">
    <label style="display:flex;align-items:center;gap:var(--sp-sm);margin-bottom:var(--sp-md)">
      <input type="checkbox" id="keyInput" style="width:20px;height:20px">
      <span>키 플레이어로 등록</span>
    </label>
    <div class="overlayActions">
      <button class="btnCancel" onclick="closeOverlay()">취소</button>
      <button class="btnConfirm" onclick="confirmAddPlayer('${tableId}', '${seatNo}')">추가</button>
    </div>
  `;

  overlay.classList.add('show');
  setTimeout(() => document.getElementById('nameInput').focus(), 100);
}

function confirmAddPlayer(tableId, seatNo) {
  const name = document.getElementById('nameInput').value.trim();
  const nation = document.getElementById('nationInput').value;
  const chipsInput = document.getElementById('chipsInput').value.trim();
  const isKey = document.getElementById('keyInput').checked;

  if (!name) {
    alert('이름을 입력하세요.');
    return;
  }
  if (!chipsInput) {
    alert('칩을 입력하세요.');
    return;
  }

  const chips = parseChips(chipsInput);
  if (chips === null || chips < 0) {
    alert('올바른 칩 숫자를 입력하세요.');
    return;
  }

  closeOverlay();
  showLoading();

  google.script.run
    .withSuccessHandler(() => {
      if (currentView === 'key' && isKey) {
        loadKeyPlayers();
      } else {
        loadTablePlayers(currentTableId);
      }
    })
    .withFailureHandler(err => {
      alert(`에러: ${err.message}`);
      hideLoading();
    })
    .addPlayer(tableId, seatNo, name, nation, chips, isKey);
}

/* ===== Delete Player ===== */
function deletePlayerConfirm(tableId, seatNo, playerName) {
  if (!confirm(`${seatNo} ${playerName} 삭제하시겠습니까?`)) return;

  showLoading();

  google.script.run
    .withSuccessHandler(() => {
      if (currentView === 'key') {
        loadKeyPlayers();
      } else {
        loadTablePlayers(currentTableId);
      }
    })
    .withFailureHandler(err => {
      alert(`에러: ${err.message}`);
      hideLoading();
    })
    .removePlayer(tableId, seatNo);
}

/* ===== Utilities ===== */
function parseChips(input) {
  if (!input) return null;
  const str = String(input).trim().toLowerCase();
  if (str.endsWith('k')) {
    const num = parseFloat(str.slice(0, -1));
    return isNaN(num) ? null : Math.round(num * 1000);
  }
  const num = parseFloat(str.replace(/[^\d.]/g, ''));
  return isNaN(num) ? null : Math.round(num);
}

function formatChips(chips) {
  if (chips >= 1000) {
    return Math.round(chips / 1000) + 'k';
  }
  return chips.toString();
}

function getFlag(nationCode) {
  const flags = {
    'KR': '🇰🇷', 'US': '🇺🇸', 'JP': '🇯🇵', 'CN': '🇨🇳', 'GB': '🇬🇧',
    'FR': '🇫🇷', 'DE': '🇩🇪', 'CA': '🇨🇦', 'AU': '🇦🇺', 'TW': '🇹🇼'
  };
  return flags[nationCode] || '🌐';
}

function getChipChange(tableId, seatNo, currentChips) {
  const key = `${tableId}_${seatNo}`;
  const history = JSON.parse(localStorage.getItem('phl_chipHistory') || '{}');
  const oldChips = history[key] || currentChips;

  const diff = currentChips - oldChips;
  if (diff > 0) {
    return { amount: diff, direction: 'up', text: `↑${formatChips(diff)}` };
  } else if (diff < 0) {
    return { amount: diff, direction: 'down', text: `↓${formatChips(Math.abs(diff))}` };
  } else {
    return { amount: 0, direction: 'same', text: '' };
  }
}

function saveChipHistory(tableId, seatNo, chips) {
  const key = `${tableId}_${seatNo}`;
  const history = JSON.parse(localStorage.getItem('phl_chipHistory') || '{}');
  history[key] = chips;
  localStorage.setItem('phl_chipHistory', JSON.stringify(history));
}

function closeOverlay() {
  document.getElementById('overlay').classList.remove('show');
}

function showLoading() {
  const list = currentView === 'key'
    ? document.getElementById('keyPlayerList')
    : document.getElementById('tablePlayerList');
  list.innerHTML = '<div class="loading">처리 중...</div>';
}

function hideLoading() {
  // 리렌더링으로 처리됨
}
</script>

</div>

  <div class="panel hidden" id="panelSoftSender">

<div class="wrap">
  <header>
    <div>
      <h1>Soft Content Sender</h1>
      <div class="muted" style="font-size:0.75em; margin-top:-4px;">v10.1 (2025-10-05)</div>
    </div>
    <div id="status">로딩중…</div>
  </header>

  <!-- 시트ID 오버라이드 -->
  <section class="field">
    <label>Sheet IDs</label>
    <div class="row two">
      <input id="cueId" placeholder="CUE Sheet ID(옵션)" />
      <input id="typeId" placeholder="TYPE Sheet ID(옵션)" />
    </div>
    <div style="display:flex;gap:10px;justify-content:flex-end;margin-top:10px;">
      <button class="btn ghost" id="btnSaveIds">ID 저장</button>
      <button class="btn ghost" id="btnClearIds">ID 초기화</button>
    </div>
    <div class="muted" id="idsHint" style="margin-top:6px;"></div>
  </section>

  <section class="field">
    <div class="row two">
      <div class="field">
        <label>행 선택(시간)</label>
        <div style="display:flex;gap:12px;align-items:center;">
          <input id="chkAuto" type="checkbox" checked style="width:auto;height:auto;transform:scale(1.4);" />
          <span class="muted">현재 시각 자동 선택</span>
        </div>
      </div>
      <div class="field">
        <label>시간 드롭다운(±20분)</label>
        <select id="selTime"><option value="">(미선택: 현재시각)</option></select>
      </div>
    </div>
  </section>

  <section class="field">
    <div class="row two">
      <div class="field">
        <label>파일명(전송 전 수정 가능) — 형식: <b>HHmm_name_mode</b></label>
        <input id="fileName" placeholder="예: 1742_John_Doe_ELIM / 1742_Table7_LEADERBOARD" />
      </div>
      <div class="field">
        <label>모드</label>
        <div class="tabs">
          <button id="tabPU" class="active">스택 업데이트(PU)</button>
          <button id="tabELIM">탈락 정보(ELIM)</button>
          <button id="tabL3">프로필 자막(L3)</button>
          <button id="tabLB">리더보드(LEADERBOARD)</button>
        </div>
      </div>
    </div>
  </section>

  <section class="field">
    <div class="field">
      <label>테이블 선택</label>
      <select id="selRoomTable"><option value="">-</option></select>
    </div>

    <div class="field">
      <label>좌석 선택</label>
      <select id="selSeat"><option value="">좌석 선택</option></select>
    </div>

    <div class="field" id="singleFields">
      <label>국가 코드 (2자리)</label>
      <input id="countryCode" placeholder="예: US, KR" readonly />
    </div>
  </section>

  <!-- PU -->
  <section id="panelPU" class="field">
    <div class="row two">
      <div class="field">
        <label>칩스택(쉼표 포함) *</label>
        <input id="stackAmt" placeholder="예: 1,234,000" inputmode="numeric" />
      </div>
      <div class="field">
        <label>Big Blind(정수) *</label>
        <input id="bigBlind" placeholder="예: 20000" inputmode="numeric" />
      </div>
    </div>
    <div class="row two">
      <div class="field">
        <label>계산된 BB (자동, 반올림)</label>
        <input id="stackBBView" readonly placeholder="예: 62BB" />
      </div>
      <input id="stackBB" type="hidden" />
    </div>
  </section>

  <!-- ELIM -->
  <section id="panelELIM" class="field" style="display:none;">
    <div class="row two">
      <div class="field">
        <label>상금 여부</label>
        <select id="selPrize">
          <option value="">상금 없음</option>
          <option value="prize">상금 있음</option>
        </select>
      </div>
      <div class="field" id="prizeDetails" style="display:none;">
        <label>순위 및 상금</label>
        <div class="row two">
          <input id="prizePlace" placeholder="예: 5" inputmode="numeric" />
          <input id="prizeAmount" placeholder="예: 10000" inputmode="numeric" />
        </div>
      </div>
    </div>
  </section>

  <!-- L3 -->
  <section id="panelL3" class="field" style="display:none;">
    <p class="muted">"프로필 자막" + 이름 2줄이 J셀에 추가됩니다.</p>
  </section>

  <!-- LEADERBOARD -->
  <section id="panelLB" class="field" style="display:none;">
    <div class="row two">
      <div class="field">
        <label>Level</label>
        <input id="lbLevel" placeholder="예: 15" inputmode="numeric" />
      </div>
      <div class="field">
        <label>Table Label (파일명용)</label>
        <input id="lbTableLabel" placeholder="예: Table7" />
      </div>
    </div>
    <div class="row three">
      <div class="field">
        <label>SB</label>
        <input id="lbSB" placeholder="예: 25000" inputmode="numeric" />
      </div>
      <div class="field">
        <label>BB</label>
        <input id="lbBB" placeholder="예: 50000" inputmode="numeric" />
      </div>
      <div class="field">
        <label>ANTE</label>
        <input id="lbAnte" placeholder="예: 50000" inputmode="numeric" />
      </div>
    </div>

    <div class="field">
      <label>플레이어 칩스택 입력(이름 자동 로드, 필요시 수정)</label>
      <div id="lbList" class="lb-list"></div>
    </div>
  </section>

  <!-- 액션 버튼 (입력 직후 바로 처리) -->
  <section class="field" style="display:flex;gap:12px;justify-content:flex-end;align-items:center;">
    <button class="btn ghost" id="btnAddToBatch" style="display:none;">
      ➕ 배치에 추가
    </button>
    <button class="btn primary" id="btnSend" style="min-width:200px;">전송</button>
  </section>

  <!-- 배치 리스트 (항목 있을 때만 표시) -->
  <section id="batchSection" class="field" style="display:none; background:var(--panel2); padding:var(--pad); border-radius:var(--radius); border:2px solid var(--accent);">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
      <label style="margin:0;">📦 배치 대기 중 (<span id="batchCount">0</span>건)</label>
      <button class="btn ghost" id="btnClearBatch" style="height:auto; padding:8px 14px; font-size:0.9em;">
        🗑️ 전체 삭제
      </button>
    </div>

    <!-- 배치 리스트 -->
    <div id="batchList" style="max-height:250px; overflow-y:auto; -webkit-overflow-scrolling:touch;">
      <!-- 동적 생성 -->
    </div>
  </section>

  <!-- 미리보기 (통합) -->
  <section class="field">
    <label id="previewLabel">미리보기</label>
    <textarea id="preview" readonly></textarea>
  </section>

  <section style="margin-top:12px;">
    <div class="muted" id="footerInfo"></div>
  </section>
</div>

<div id="toast"></div>

<script>
  const LS_KEYS = { CUE:'SCS_CUE_ID', TYPE:'SCS_TYPE_ID' };

  // 상수 정의
const CONSTANTS = {
  TOAST_DURATION: 1800,
  DEFAULT_SEAT_INDEX: 1,
  DEBOUNCE_DELAY: 300,
  MODES: {
    PU: 'PU',
    ELIM: 'ELIM',
    L3: 'L3',
    LEADERBOARD: 'LEADERBOARD'
  },
  DISPLAY: {
    GRID: 'grid',
    BLOCK: 'block',
    NONE: 'none'
  }
};

const state = {
  mode: CONSTANTS.MODES.ELIM,
  tz: 'Asia/Seoul',
  typeRows: [],
  byRoom: {},
  byRoomTable: {},
  tableList: [],     // Room+Table 통합 목록
  timeCenter: '',
  cueId: '',
  typeId: '',
  batch: []          // 배치 전송용 배열
};

  function toast(msg, ok=true){
  const t=document.getElementById('toast');
  t.textContent=msg; t.className='show'+(ok?'':' err');
  setTimeout(()=>t.className='', CONSTANTS.TOAST_DURATION);
}
function setStatus(s){ document.getElementById('status').textContent=s; }

/* ===== Sheet ID 저장/초기화 ===== */
function loadIdsFromLocal(){
  const cue = localStorage.getItem(LS_KEYS.CUE) || '';
  const type= localStorage.getItem(LS_KEYS.TYPE) || '';
  if (cue) document.getElementById('cueId').value = cue;
  if (type) document.getElementById('typeId').value = type;
  state.cueId = cue;
  state.typeId= type;
  renderIdsHint();
}
function saveIds(){
  const cue = document.getElementById('cueId').value.trim();
  const type= document.getElementById('typeId').value.trim();
  if (cue) localStorage.setItem(LS_KEYS.CUE, cue); else localStorage.removeItem(LS_KEYS.CUE);
  if (type) localStorage.setItem(LS_KEYS.TYPE, type); else localStorage.removeItem(LS_KEYS.TYPE);
  state.cueId = cue; state.typeId = type;
  renderIdsHint();
  toast('ID 저장 완료');
  reloadSheets();
}
function clearIds(){
  localStorage.removeItem(LS_KEYS.CUE);
  localStorage.removeItem(LS_KEYS.TYPE);
  state.cueId=''; state.typeId='';
  document.getElementById('cueId').value='';
  document.getElementById('typeId').value='';
  renderIdsHint();
  toast('ID 초기화 완료(기본값 사용)');
  reloadSheets();
}
function renderIdsHint(){
  const c = state.cueId ? `CUE=${state.cueId}` : 'CUE=기본값';
  const t = state.typeId? `TYPE=${state.typeId}`: 'TYPE=기본값';
  document.getElementById('idsHint').textContent = `현재 사용 중: ${c} | ${t}`;
}

/* 인덱싱 */
function indexTypeRows(rows){
  state.byRoom={}; state.byRoomTable={}; state.tableList=[];
  rows.forEach(r=>{
    (state.byRoom[r.room] ||= []).push(r);
    const key = r.room + '|' + r.tno;
    (state.byRoomTable[key] ||= []).push(r);
  });

  // Room+Table 통합 목록 생성
  Object.keys(state.byRoomTable).forEach(key => {
    const [room, tno] = key.split('|');
    const tname = state.byRoomTable[key][0]?.tname || '';
    state.tableList.push({
      key,
      label: tname ? `${room} - ${tname} (Table ${tno})` : `${room} - Table ${tno}`,
      room,
      tno
    });
  });

  // 정렬: Room → Table No.
  state.tableList.sort((a,b) => {
    if (a.room !== b.room) return a.room.localeCompare(b.room);
    return Number(a.tno) - Number(b.tno);
  });
}
function normSeat(s){
  const t = String(s||'').trim();
  if(!t) return '';
  const n = t.replace(/\s/g,'').replace(/^#?/,'');
  return '#'+n;
}

/* 플레이어 조회 헬퍼 함수 */
function findPlayerBySeat(key, seat) {
  if (!key || !seat) return null;
  const arr = state.byRoomTable[key] || [];
  return arr.find(r => normSeat(r.seat) === normSeat(seat));
}

/* ===== UI 채우기 ===== */
function fillRoomTables(){
  const sel = document.getElementById('selRoomTable');
  sel.innerHTML = '<option value="">-</option>';

  const fragment = document.createDocumentFragment();
  state.tableList.forEach(t => {
    const o = document.createElement('option');
    o.value = t.key;
    o.textContent = t.label;
    fragment.appendChild(o);
  });
  sel.appendChild(fragment);

  if (sel.options.length > 1) sel.selectedIndex = CONSTANTS.DEFAULT_SEAT_INDEX;
  fillSeats();
}

function fillSeats(){
  const key = document.getElementById('selRoomTable').value;
  const selSeat = document.getElementById('selSeat');
  const prevSeat = selSeat.value;

  selSeat.innerHTML = '<option value="">좌석 선택</option>';

  if (!key) return;

  const arr = state.byRoomTable[key] || [];

  // Seat 드롭다운: "#1 - John Doe" 형식
  const seats = [...new Set(arr.map(r => normSeat(r.seat)))]
    .sort((a,b) => Number(a.replace('#','')) - Number(b.replace('#','')));

  const fragment = document.createDocumentFragment();
  seats.forEach(s => {
    const player = findPlayerBySeat(key, s);
    const o = document.createElement('option');
    o.value = s;
    o.textContent = `${s} - ${player?.player || ''}`;
    fragment.appendChild(o);
  });
  selSeat.appendChild(fragment);

  const idx = seats.indexOf(prevSeat);
  selSeat.selectedIndex = idx >= 0 ? idx + CONSTANTS.DEFAULT_SEAT_INDEX : (seats.length > 0 ? CONSTANTS.DEFAULT_SEAT_INDEX : 0);

  applyPickFromSeat();
  if(state.mode===CONSTANTS.MODES.LEADERBOARD) buildLeaderboardList();
  rebuildFileName();
}

function applyPickFromSeat(){
  const key = document.getElementById('selRoomTable').value;
  const seat = document.getElementById('selSeat').value;
  const pick = findPlayerBySeat(key, seat);

  if (pick){
    document.getElementById('countryCode').value = pick.nat || '';
  }
  rebuildPreview();
  rebuildFileName();
}

/* 시간 옵션 */
function fillTimes(list, center){
  const sel = document.getElementById('selTime');
  sel.innerHTML = '<option value="">(미선택: 현재시각)</option>';

  const fragment = document.createDocumentFragment();
  list.forEach(v=>{
    const o=document.createElement('option');
    o.value=v; o.textContent = (v===center)? `${v}  ← 현재` : v;
    fragment.appendChild(o);
  });
  sel.appendChild(fragment);
}

/* 파일명 */
function hhmmFromTimeStr(t){ return (t||'').replace(':',''); }
function rebuildFileName(){
  const mode   = state.mode;
  const key    = document.getElementById('selRoomTable').value;
  const tno    = key ? key.split('|')[1] : '';
  const picked = document.getElementById('selTime').value;
  const hhmm   = hhmmFromTimeStr( picked || (state.timeCenter||'').slice(0,5) );

  let nameForMode;
  if (mode === CONSTANTS.MODES.LEADERBOARD) {
    nameForMode = document.getElementById('lbTableLabel').value || ('Table'+tno);
  } else {
    const player = getSelectedPlayer();
    nameForMode = player ? player.player : 'Player';
  }

  google.script.run.withSuccessHandler(name=>{
    document.getElementById('fileName').value = name;
  }).buildFileName(mode, hhmm, tno, nameForMode);
}

/* 숫자 유틸 */
function parseIntClean(s){ const n = Number(String(s||'').replace(/[^0-9]/g,'')); return isNaN(n)?0:Math.round(n); }
function comma(n){ return Number(n||0).toLocaleString('en-US'); }

/* 디바운싱 유틸 */
function debounce(func, delay) {
  let timer;
  return (...args) => {
    clearTimeout(timer);
    timer = setTimeout(() => func(...args), delay);
  };
}

/* 입력창 실시간 콤마 포맷 */
function formatInputWithComma(el){
  const v = parseIntClean(el.value);
  el.value = v ? comma(v) : '';
}

/* PU: BB(반올림) */
function computeBB(){
  const amt = parseIntClean(document.getElementById('stackAmt').value);
  const bb  = parseIntClean(document.getElementById('bigBlind').value);
  const res = (amt>0 && bb>0) ? Math.round(amt / bb) : '';
  document.getElementById('stackBB').value = res || '';
  document.getElementById('stackBBView').value = res ? `${res}BB` : '';
}

/* LEADERBOARD */
let lbListListenerAttached = false;
let lbTableLabelListenerAttached = false;

function buildLeaderboardList(){
  const key = document.getElementById('selRoomTable').value;
  if (!key) return;

  const arr = (state.byRoomTable[key]||[]).slice()
                .sort((a,b)=>Number(a.seat.replace('#',''))-Number(b.seat.replace('#','')));
  const list = document.getElementById('lbList');
  list.innerHTML = '';

  arr.forEach((r,i)=>{
    const row = document.createElement('div'); row.className='lb-row';
    row.innerHTML = `
      <input class="lbName" value="${(r.player||'')}" />
      <input class="lbAmt"  placeholder="칩스택(예: 4,190,000)" inputmode="numeric" />
    `;
    list.appendChild(row);
  });

  // 이벤트 위임으로 한 번만 등록
  if (!lbListListenerAttached) {
    list.addEventListener('input', (e) => {
      if (e.target.classList.contains('lbAmt')) {
        formatInputWithComma(e.target);
        rebuildPreview();
      } else if (e.target.classList.contains('lbName')) {
        rebuildPreview();
      }
    });
    lbListListenerAttached = true;
  }

  const tno = key.split('|')[1];
  const tlabel = document.getElementById('lbTableLabel');
  if(!tlabel.value) tlabel.value = 'Table'+tno;

  if (!lbTableLabelListenerAttached) {
    tlabel.addEventListener('input', rebuildFileName);
    lbTableLabelListenerAttached = true;
  }

  rebuildPreview();
  rebuildFileName();
}

function nameToInitialLastUpper(full){
  const parts = String(full||'').trim().split(/\s+/);
  if(parts.length===0 || !parts[0]) return '';
  const initial = (parts[0][0]||'').toUpperCase()+'.';
  const last = parts.slice(1).join(' ').toUpperCase();
  return last ? `${initial} ${last}` : initial;
}

// 숫자 → K/M 표기(블라인드 라벨용)
function formatKM(nStr){
  const n = parseIntClean(nStr);
  const [divisor, suffix] = n >= 1_000_000 ? [1_000_000, 'M'] : [1_000, 'K'];

  const formatted = (n / divisor).toFixed(2)
    .replace(/\.0+$/,'')
    .replace(/(\.\d)0$/,'$1');

  return `${formatted}${suffix}`;
}

/* 선택된 플레이어 정보 가져오기 */
function getSelectedPlayer(){
  const key = document.getElementById('selRoomTable').value;
  const seat = document.getElementById('selSeat').value;
  return findPlayerBySeat(key, seat);
}

/* ===== 데이터 재로드 ===== */
function reloadSheets(){
  setStatus('시트 정보 로딩…');
  google.script.run.withSuccessHandler(res=>{
    if(res?.ok){ state.timeCenter = res.center || ''; fillTimes(res.list||[], res.center||''); rebuildFileName(); }
    else toast('시간 목록 로딩 실패: '+(res?.error||'unknown'), false);
    setStatus('준비됨');
  }).getTimeOptions(state.cueId || null);

  google.script.run.withSuccessHandler(res=>{
    if(res?.ok){ state.typeRows = res.rows||[]; indexTypeRows(state.typeRows); fillRoomTables(); }
    else toast('Type 탭 로딩 실패: '+(res?.error||'unknown'), false);
  }).getTypeRows(state.typeId || null);
}

  /* 미리보기(전부 대문자 출력) */
function rebuildPreview(){
  const mode = state.mode;

  // DOM 요소 캐싱
  const els = {
    stackAmt: document.getElementById('stackAmt'),
    stackBB: document.getElementById('stackBB'),
    selPrize: document.getElementById('selPrize'),
    lbLevel: document.getElementById('lbLevel'),
    lbSB: document.getElementById('lbSB'),
    lbBB: document.getElementById('lbBB'),
    lbAnte: document.getElementById('lbAnte'),
    preview: document.getElementById('preview')
  };

  let body='';

  if(mode===CONSTANTS.MODES.PU){
    computeBB();
    const player = getSelectedPlayer();
    if (!player) { body = ''; }
    else {
      const name = (player.player || '').toUpperCase();
      const country = (player.nat || '').toUpperCase();
      const amt = (els.stackAmt.value||'').toUpperCase();
      const bb = (els.stackBB.value||'').toUpperCase();
      body = `${name} / ${country}\nCURRENT STACK - ${amt} (${bb}BB)`;
    }
  }else if(mode===CONSTANTS.MODES.ELIM){
    const player = getSelectedPlayer();
    if (!player) { body = ''; }
    else {
      const name = (player.player || '').toUpperCase();
      const country = (player.nat || '').toUpperCase();

      if (els.selPrize.value === 'prize') {
        const place = (document.getElementById('prizePlace').value || '').trim();
        const amount = (document.getElementById('prizeAmount').value || '').trim();
        const prizeText = place && amount ? `ELIMINATED IN ${place}TH PLACE (${amount})` : 'ELIMINATED';
        body = `${name} / ${country}\n${prizeText}`;
      } else {
        body = `${name} / ${country}\nELIMINATED`;
      }
    }
  }else if(mode===CONSTANTS.MODES.L3){
    const player = getSelectedPlayer();
    if (!player) { body = ''; }
    else {
      const name = (player.player || '').toUpperCase();
      body = `프로필 자막\n${name}`;
    }
  }else if(mode===CONSTANTS.MODES.LEADERBOARD){
    const level = (els.lbLevel.value||'').trim();
    const sb    = comma(parseIntClean(els.lbSB.value));
    const bb    = comma(parseIntClean(els.lbBB.value));
    const ante  = comma(parseIntClean(els.lbAnte.value));
    const rows = [];
    document.querySelectorAll('#lbList .lb-row').forEach(r=>{
      const name = r.querySelector('.lbName').value;
      const amt  = r.querySelector('.lbAmt').value;
      const chips = parseIntClean(amt);
      if(chips>0) rows.push({name, amt: comma(chips)});
    });
    rows.sort((a,b)=>parseInt(b.amt.replace(/,/g,'')) - parseInt(a.amt.replace(/,/g,'')));
    const lines = rows.map(o => `${nameToInitialLastUpper(o.name)}    ${o.amt}`.toUpperCase());
    const footer = `LV ${String(level||'').toUpperCase()} | BLINDS ${formatKM(sb)} / ${formatKM(bb)} - ${formatKM(ante)}`;
    body = lines.join('\n') + (lines.length?'\n\n':'') + footer;
  }
  els.preview.value = body;
}

// 현재 입력 미리보기 생성
function generateCurrentPreview() {
  const mode = state.mode;
  const els = {
    stackAmt: document.getElementById('stackAmt'),
    stackBB: document.getElementById('stackBB'),
    selPrize: document.getElementById('selPrize'),
    lbLevel: document.getElementById('lbLevel'),
    lbSB: document.getElementById('lbSB'),
    lbBB: document.getElementById('lbBB'),
    lbAnte: document.getElementById('lbAnte')
  };

  let body = '';

  if (mode === CONSTANTS.MODES.PU) {
    computeBB();
    const player = getSelectedPlayer();
    if (player) {
      const name = (player.player || '').toUpperCase();
      const country = (player.nat || '').toUpperCase();
      const amt = (els.stackAmt.value || '').toUpperCase();
      const bb = (els.stackBB.value || '').toUpperCase();
      body = `${name} / ${country}\nCURRENT STACK - ${amt} (${bb}BB)`;
    }
  } else if (mode === CONSTANTS.MODES.ELIM) {
    const player = getSelectedPlayer();
    if (player) {
      const name = (player.player || '').toUpperCase();
      const country = (player.nat || '').toUpperCase();
      if (els.selPrize.value === 'prize') {
        const place = (document.getElementById('prizePlace').value || '').trim();
        const amount = (document.getElementById('prizeAmount').value || '').trim();
        const prizeText = place && amount ? `ELIMINATED IN ${place}TH PLACE (${amount})` : 'ELIMINATED';
        body = `${name} / ${country}\n${prizeText}`;
      } else {
        body = `${name} / ${country}\nELIMINATED`;
      }
    }
  } else if (mode === CONSTANTS.MODES.L3) {
    const player = getSelectedPlayer();
    if (player) {
      const name = (player.player || '').toUpperCase();
      body = `프로필 자막\n${name}`;
    }
  } else if (mode === CONSTANTS.MODES.LEADERBOARD) {
    const level = (els.lbLevel.value || '').trim();
    const sb = comma(parseIntClean(els.lbSB.value));
    const bb = comma(parseIntClean(els.lbBB.value));
    const ante = comma(parseIntClean(els.lbAnte.value));
    const rows = [];
    document.querySelectorAll('#lbList .lb-row').forEach(r => {
      const name = r.querySelector('.lbName').value;
      const amt = r.querySelector('.lbAmt').value;
      const chips = parseIntClean(amt);
      if (chips > 0) rows.push({ name, amt: comma(chips) });
    });
    rows.sort((a, b) => parseInt(b.amt.replace(/,/g, '')) - parseInt(a.amt.replace(/,/g, '')));
    const lines = rows.map(o => `${nameToInitialLastUpper(o.name)}    ${o.amt}`.toUpperCase());
    const footer = `LV ${String(level || '').toUpperCase()} | BLINDS ${formatKM(sb)} / ${formatKM(bb)} - ${formatKM(ante)}`;
    body = lines.join('\n') + (lines.length ? '\n\n' : '') + footer;
  }

  return body;
}

// 미리보기 통합 업데이트
function updateBatchPreview() {
  const previewEl = document.getElementById('preview');
  const previewLabel = document.getElementById('previewLabel');

  if (state.batch.length > 0) {
    // 배치 모드: 배치 전체 내용 + 현재 입력 표시
    const batchContent = state.batch.map(item => item.content).join('\n\n');
    const currentPreview = generateCurrentPreview();

    previewLabel.textContent = `미리보기 (배치 ${state.batch.length}건 + 현재 입력)`;
    previewEl.value = `=== 배치 전송될 내용 (${state.batch.length}건) ===\n\n${batchContent}\n\n=== 현재 입력 (배치에 추가하려면 [➕ 배치에 추가] 클릭) ===\n\n${currentPreview}`;
  } else {
    // 단일 모드
    previewLabel.textContent = '미리보기';
    rebuildPreview();
  }
}

  /* ===== 배치 빌더 (스마트 통합) ===== */

// 스마트 전송 버튼 업데이트
function updateSendButton() {
  const btnSend = document.getElementById('btnSend');
  const btnAddToBatch = document.getElementById('btnAddToBatch');
  const batchSection = document.getElementById('batchSection');

  if (state.batch.length > 0) {
    // 배치 모드
    btnSend.innerHTML = `📤 배치 전송 (${state.batch.length}건)`;
    batchSection.style.display = 'block';
  } else {
    // 단일 모드
    btnSend.innerHTML = '전송';
    batchSection.style.display = 'none';
  }

  // 배치 추가 버튼은 LEADERBOARD 모드가 아닐 때 항상 표시
  btnAddToBatch.style.display = (state.mode === CONSTANTS.MODES.LEADERBOARD) ? 'none' : 'block';
}

// 배치에 추가
function addToBatch() {
  const preview = document.getElementById('preview').value.trim();

  if (!preview) {
    toast('미리보기가 비어있습니다. 먼저 플레이어를 선택하고 정보를 입력하세요.', false);
    return;
  }

  const player = getSelectedPlayer();
  const mode = state.mode;

  state.batch.push({
    mode,
    player: player?.player || 'Unknown',
    seat: player?.seat || '',
    nat: player?.nat || '',
    content: preview
  });

  renderBatchList();
  updateBatchPreview();
  updateSendButton();
  toast(`✅ 배치에 추가됨 (${state.batch.length}건)`, true);

  moveToNextSeat();
}

// 배치 리스트 렌더링
function renderBatchList() {
  const list = document.getElementById('batchList');

  if (state.batch.length === 0) {
    list.innerHTML = '';
    document.getElementById('batchCount').textContent = '0';
    return;
  }

  list.innerHTML = '';

  state.batch.forEach((item, idx) => {
    const div = document.createElement('div');
    div.style.cssText = 'background:var(--panel); padding:14px; border-radius:12px; display:flex; justify-content:space-between; align-items:center; margin-bottom:10px; min-height:44px;';

    div.innerHTML = `
      <div style="flex:1; min-width:0;">
        <div style="font-weight:600; font-size:0.95em;">
          ${idx + 1}. ${item.seat} ${item.player}
          <span style="color:var(--accent); margin-left:8px; font-size:0.85em;">[${item.mode}]</span>
        </div>
        <div class="muted" style="font-size:0.8em; margin-top:4px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">
          ${item.content.replace(/\n/g, ' · ').substring(0, 60)}...
        </div>
      </div>
      <button class="btn ghost" data-idx="${idx}" style="padding:10px 16px; height:auto; font-size:0.85em; margin-left:10px; flex-shrink:0;">
        삭제
      </button>
    `;

    div.querySelector('button').addEventListener('click', (e) => {
      const idx = parseInt(e.target.dataset.idx);
      state.batch.splice(idx, 1);
      renderBatchList();
      updateBatchPreview();
      updateSendButton();
      toast('항목 삭제됨', true);
    });

    list.appendChild(div);
  });

  document.getElementById('batchCount').textContent = state.batch.length;
}

// 다음 좌석으로 자동 이동
function moveToNextSeat() {
  const key = document.getElementById('selRoomTable').value;
  const seat = document.getElementById('selSeat').value;
  const arr = state.byRoomTable[key] || [];

  const seats = [...new Set(arr.map(r => normSeat(r.seat)))]
    .sort((a,b) => Number(a.replace('#','')) - Number(b.replace('#','')));

  const currentIndex = seats.indexOf(seat);

  if (currentIndex >= 0 && currentIndex < seats.length - 1) {
    const nextSeat = seats[currentIndex + 1];
    document.getElementById('selSeat').value = nextSeat;
    applyPickFromSeat();
    rebuildPreview();
    rebuildFileName();
  } else {
    if (seats.length > 0) {
      document.getElementById('selSeat').value = seats[0];
      applyPickFromSeat();
      rebuildPreview();
      rebuildFileName();
    }
  }
}

// 배치 전송
function sendBatch() {
  if (state.batch.length === 0) {
    toast('배치가 비어있습니다.', false);
    return;
  }

  const jBlock = state.batch.map(item => item.content).join('\n\n');

  const autoNow = document.getElementById('chkAuto').checked;
  const picked = document.getElementById('selTime').value;
  const timeStr = autoNow ? state.timeCenter.slice(0,5) : picked;
  const hhmm = hhmmFromTimeStr(timeStr);
  const filename = `${hhmm}_Batch_${state.batch.length}items`;

  const payload = {
    autoNow,
    pickedTime: picked,
    tz: state.tz,
    kind: 'BATCH',
    eFix: '미완료',
    gFix: 'SOFT',
    filename,
    jBlock,
    cueId: state.cueId || undefined
  };

  setStatus('전송 중…');

  google.script.run
    .withSuccessHandler(res => {
      if (!res?.ok) {
        toast('❌ 전송 실패: ' + (res?.error || 'unknown'), false);
        setStatus('에러');
        return;
      }

      toast(`✅ 배치 전송 완료! ${state.batch.length}건이 행 ${res.row}(${res.time})에 저장되었습니다.`, true);
      setStatus('준비됨');

      state.batch = [];
      renderBatchList();
      updateBatchPreview();
      updateSendButton();
    })
    .withFailureHandler(err => {
      toast('❌ 서버 오류: ' + (err?.message || err), false);
      setStatus('에러');
    })
    .updateVirtual(payload);
}

/* 스마트 전송 (단일/배치 자동 감지) */
function send(){
  // 배치 모드인지 확인
  if (state.batch.length > 0) {
    sendBatch();
    return;
  }

  // 단일 전송
  sendSingle();
}

// 단일 전송
function sendSingle() {
  const autoNow = document.getElementById('chkAuto').checked;
  const picked  = document.getElementById('selTime').value;
  const filename= document.getElementById('fileName').value.trim();
  const jBlock  = generateCurrentPreview(); // 배치 미리보기 제외

  if(!jBlock){ toast('미리보기 내용이 비었습니다.', false); return; }
  if(!filename){ toast('파일명 비어있음.', false); return; }
  if(state.mode===CONSTANTS.MODES.PU){
    if(!parseIntClean(document.getElementById('stackAmt').value) || !parseIntClean(document.getElementById('bigBlind').value)){
      toast('칩스택/빅블을 입력하세요.', false); return;
    }
  }
  if(state.mode===CONSTANTS.MODES.LEADERBOARD){
    const ok = !!document.getElementById('lbLevel').value.trim()
      && parseIntClean(document.getElementById('lbSB').value)>0
      && parseIntClean(document.getElementById('lbBB').value)>0
      && parseIntClean(document.getElementById('lbAnte').value)>0
      && Array.from(document.querySelectorAll('#lbList .lbAmt')).some(i=>parseIntClean(i.value)>0);
    if(!ok){ toast('레벨/SB/BB/ANTE 및 칩스택을 입력하세요.', false); return; }
  }
  if(state.mode===CONSTANTS.MODES.ELIM){
    const prizeValue = document.getElementById('selPrize').value;
    if(prizeValue === 'prize'){
      const place = document.getElementById('prizePlace').value.trim();
      const amount = document.getElementById('prizeAmount').value.trim();
      if(!place || !amount){
        toast('순위와 상금을 입력하세요.', false); return;
      }
    }
  }

  setStatus('전송 중…');
  google.script.run.withSuccessHandler(res=>{
    if(!res?.ok){ toast('실패: '+(res?.error||'unknown'), false); setStatus('에러'); return; }
    toast(`행 ${res.row}(${res.time}) 갱신 완료`);
    setStatus('준비됨');
  }).withFailureHandler(err=>{
    toast('서버 오류: '+(err?.message||err), false);
    setStatus('에러');
  }).updateVirtual({
    autoNow,
    pickedTime: picked,
    tz: state.tz,
    kind: state.mode,
    eFix: '미완료',
    gFix: 'SOFT',
    filename,
    jBlock,
    cueId: state.cueId || undefined
  });
}

  // 모드 변경
function setMode(m){
  state.mode = m;
  document.getElementById('tabPU').classList.toggle('active', m===CONSTANTS.MODES.PU);
  document.getElementById('tabELIM').classList.toggle('active', m===CONSTANTS.MODES.ELIM);
  document.getElementById('tabL3').classList.toggle('active', m===CONSTANTS.MODES.L3);
  document.getElementById('tabLB').classList.toggle('active', m===CONSTANTS.MODES.LEADERBOARD);

  document.getElementById('panelPU').style.display   = (m===CONSTANTS.MODES.PU)?CONSTANTS.DISPLAY.BLOCK:CONSTANTS.DISPLAY.NONE;
  document.getElementById('panelELIM').style.display = (m===CONSTANTS.MODES.ELIM)?CONSTANTS.DISPLAY.BLOCK:CONSTANTS.DISPLAY.NONE;
  document.getElementById('panelL3').style.display   = (m===CONSTANTS.MODES.L3)?CONSTANTS.DISPLAY.BLOCK:CONSTANTS.DISPLAY.NONE;
  document.getElementById('panelLB').style.display   = (m===CONSTANTS.MODES.LEADERBOARD)?CONSTANTS.DISPLAY.BLOCK:CONSTANTS.DISPLAY.NONE;

  const showSingle = (m!==CONSTANTS.MODES.LEADERBOARD);
  document.getElementById('singleFields').style.display= showSingle ? CONSTANTS.DISPLAY.GRID : CONSTANTS.DISPLAY.NONE;

  // 배치 작업 중 모드 변경 시 피드백
  if (state.batch.length > 0) {
    const modeNames = {
      PU: '스택 업데이트',
      ELIM: '탈락 정보',
      L3: '프로필 자막',
      LEADERBOARD: '리더보드'
    };
    toast(`⚠️ 모드 변경: ${modeNames[m]}`, true);
  }

  if(m===CONSTANTS.MODES.LEADERBOARD) buildLeaderboardList();
  rebuildPreview();
  rebuildFileName();
  updateSendButton();  // 모드 변경 시 버튼 상태 업데이트
}

  function init(){
  google.script.run.withSuccessHandler(info=>{
    state.tz = info?.tz || 'Asia/Seoul';
    document.getElementById('footerInfo').textContent =
      `기본 CUE: ${info?.cueId}  |  기본 TYPE: ${info?.typeId}  |  TZ=${state.tz}`;
    setStatus('준비됨');
  }).getBootstrap();

  loadIdsFromLocal();
  reloadSheets();

  document.getElementById('btnSaveIds').onclick = saveIds;
  document.getElementById('btnClearIds').onclick = clearIds;

  document.getElementById('tabPU').onclick   = ()=>setMode(CONSTANTS.MODES.PU);
  document.getElementById('tabELIM').onclick = ()=>setMode(CONSTANTS.MODES.ELIM);
  document.getElementById('tabL3').onclick   = ()=>setMode(CONSTANTS.MODES.L3);
  document.getElementById('tabLB').onclick   = ()=>setMode(CONSTANTS.MODES.LEADERBOARD);
  document.getElementById('btnSend').onclick = send;

  // 배치 추가 버튼
  document.getElementById('btnAddToBatch').addEventListener('click', addToBatch);

  // 배치 전체 삭제
  document.getElementById('btnClearBatch').addEventListener('click', () => {
    if (state.batch.length === 0) return;

    if (confirm(`${state.batch.length}개 항목을 모두 삭제하시겠습니까?`)) {
      state.batch = [];
      renderBatchList();
      updateBatchPreview();
      updateSendButton();
      toast('배치 초기화됨', true);
    }
  });

  // 키보드 단축키: Ctrl+B
  document.addEventListener('keydown', (e) => {
    if ((e.ctrlKey || e.metaKey) && e.key === 'b') {
      e.preventDefault();
      if (state.batch.length > 0 || document.getElementById('btnAddToBatch').style.display !== 'none') {
        addToBatch();
      }
    }
  });

  document.getElementById('selRoomTable').addEventListener('change', fillSeats);
  document.getElementById('selSeat').addEventListener('change', applyPickFromSeat);

  // 디바운싱된 미리보기 갱신
  const debouncedRebuild = debounce(() => {
    rebuildPreview();
    rebuildFileName();
  }, CONSTANTS.DEBOUNCE_DELAY);

  const stackAmt = document.getElementById('stackAmt');
  stackAmt.addEventListener('input', ()=>{ formatInputWithComma(stackAmt); computeBB(); debouncedRebuild(); });
  const bigBlind = document.getElementById('bigBlind');
  bigBlind.addEventListener('input', ()=>{ formatInputWithComma(bigBlind); computeBB(); debouncedRebuild(); });

  // ELIM 모드: 상금 여부에 따라 입력란 표시/숨김
  document.getElementById('selPrize').addEventListener('change', (e) => {
    const prizeDetails = document.getElementById('prizeDetails');
    prizeDetails.style.display = e.target.value === 'prize' ? CONSTANTS.DISPLAY.BLOCK : CONSTANTS.DISPLAY.NONE;
    rebuildPreview();
  });

  // ELIM 모드: 순위/상금 입력 시 미리보기 갱신
  document.getElementById('prizePlace').addEventListener('input', debouncedRebuild);
  document.getElementById('prizeAmount').addEventListener('input', debouncedRebuild);

  setMode(CONSTANTS.MODES.ELIM);
}

window.addEventListener('load', init);

</script>

</div>

  <div class="panel hidden" id="panelSettings">
    <h3>⚙️ 설정</h3>
    <div class="panel" style="background:#0e1322">
      <label>External Sheet ID (VIRTUAL 시트)</label>
      <input id="extSheetId" type="text" placeholder="예: 13LpVWYH... (VIRTUAL 시트 소속 스프레드시트 ID)" style="width:100%;margin-top:8px"/>
      <div class="row" style="margin-top:12px">
        <button id="saveSettingsBtn" type="button" class="btnPrimary">저장</button>
        <span id="settingsMsg" class="small muted"></span>
      </div>
    </div>
  </div>
</div>

<footer class="row"><span class="small muted" id="footerVersion">BTN만 · 사이드팟 자동계산 없음 · 보드 미완성 허용 · ALL-IN 금액 수동 · v2.3</span></footer>

<!-- 홀카드 선택 오버레이 -->
<div id="overlay"><div class="box">
  <div class="row small"><b id="ovTitle">홀카드 선택</b><span class="muted"> · 2장까지 선택 · 탭=선택/해제</span><span class="muted" id="ovCount"></span></div>
  <div id="boardRowOverlay" class="boardWrap" style="margin-top:6px"></div>
  <div class="row" style="margin-top:10px;justify-content:flex-end"><button type="button" onclick="closeOverlay()">닫기</button></div>
</div></div>

<script>
/* ===== Poker Hand Logger — VERSION 상수 참조 ===== */

// 버전 정보 동적 업데이트
document.addEventListener('DOMContentLoaded', ()=>{
  const versionText = ` · 모바일 최적화 · 기여액 기반 · ${VERSION}`;
  const footerText = `BTN만 · 사이드팟 자동계산 없음 · 보드 미완성 허용 · ALL-IN 금액 수동 · ${VERSION}`;
  document.getElementById('versionTag').textContent = versionText;
  document.getElementById('footerVersion').textContent = footerText;
});

const S={tables:[],roster:{},cfg:{},
  curTable:null,startStreetInit:'PREFLOP',curStreet:'PREFLOP',
  btnSeat:null,seats:[],activeSeatMap:{},prePot:0,actions:[],nextSeq:1,board:[],
  toCall:0,pot:0,contrib:{},allin:{},folded:{},actorIdx:0,order:[],acted:new Set(),
  holes:{},holePickSeat:null,handNo:'',stacks:{},
  extSheetId:'',bbValue:0};

const SUITS=['s','h','d','c'];
const RANKS=['A','K','Q','J','T','9','8','7','6','5','4','3','2'];

/* ===== 초기 로딩 ===== */
google.script.run.withSuccessHandler(initFromConfig).getConfig();

function initFromConfig(data){
  S.tables=data.tables; S.roster=data.roster; S.cfg=data.config||{};
  // 설정 복원
  S.extSheetId = localStorage.getItem('phl_extSheetId')||'';
  S.bbValue = toInt(localStorage.getItem('phl_bbSize')||'0');
  document.getElementById('extSheetId').value=S.extSheetId;
  document.getElementById('bbInput').value=S.bbValue||'';
  document.getElementById('saveSettingsBtn').onclick=saveSettings_;
  document.getElementById('settingsMsg').textContent= S.extSheetId ? '시트ID 저장됨' : '시트ID를 설정하세요';

  const sel=document.getElementById('tableSel');
  sel.innerHTML = `<option value="">테이블 선택</option>${S.tables.map(t=>`<option value="${t}">${t}</option>`).join('')}`;
  sel.onchange=onTableChange;

  const streetSel=document.getElementById('streetStart');
  streetSel.onchange=e=>{ S.startStreetInit=e.target.value; S.curStreet=S.startStreetInit; resetHandState(false); renderAll(); };

  document.getElementById('btnSeat').onchange=e=>{S.btnSeat=toInt(e.target.value); buildTurnOrder(); renderAll();};
  document.getElementById('prePot').oninput=e=>{S.prePot=toInt(e.target.value); S.pot=S.prePot+sumObj(S.contrib); renderPot();};
  document.getElementById('handNo').oninput=e=>{S.handNo=e.target.value||'';};
  document.getElementById('bbInput').oninput=e=>{S.bbValue=toInt(e.target.value); localStorage.setItem('phl_bbSize',S.bbValue);};
  document.getElementById('undoBtn').onclick=undoOnce;
  document.getElementById('commitBtn').onclick=commitHand;
  document.getElementById('newHandBtn').onclick=()=>resetHandState(true);
  document.getElementById('refreshList').onclick=()=>loadList(true);
  document.getElementById('pushVirtualBtn').onclick=pushToVirtualSheet;
  document.getElementById('modeRecord').onclick=()=>setMode('record');
  document.getElementById('modeReview').onclick=()=>setMode('review');
  document.getElementById('modeSettings').onclick=()=>setMode('settings');

  // v1.2.0: 무한 스크롤
  document.getElementById('list').addEventListener('scroll', e=>{
    const el=e.target; if(el.scrollHeight-el.scrollTop-el.clientHeight<100) loadList(false);
  });

  setMode('record');
  buildBoardUI('boardRowRecord', toggleBoardCard);
  buildBoardUI('boardRowOverlay', pickCardOverlay);
  document.getElementById('streetStart').value=S.startStreetInit;
  renderAll();
  loadList();
}

function saveSettings_(){
  S.extSheetId = (document.getElementById('extSheetId').value||'').trim();
  localStorage.setItem('phl_extSheetId', S.extSheetId);
  document.getElementById('settingsMsg').textContent='✅ 저장됨';
  setTimeout(()=>document.getElementById('settingsMsg').textContent='',2000);
}

function setMode(m){
  const rec=document.getElementById('panelRecord'), rev=document.getElementById('panelReview'), set=document.getElementById('panelSettings');
  const bR=document.getElementById('modeRecord'), bV=document.getElementById('modeReview'), bS=document.getElementById('modeSettings');

  // 모든 패널 숨김
  rec.classList.add('hidden'); rev.classList.add('hidden'); set.classList.add('hidden');
  bR.classList.remove('btnPrimary'); bV.classList.remove('btnPrimary'); bS.classList.remove('btnPrimary');

  if(m==='record'){
    rec.classList.remove('hidden'); bR.classList.add('btnPrimary');
  }else if(m==='review'){
    rev.classList.remove('hidden'); bV.classList.add('btnPrimary'); loadList(true);
  }else if(m==='settings'){
    set.classList.remove('hidden'); bS.classList.add('btnPrimary');
  }
}

/* ===== 테이블 변경 ===== */
function onTableChange(e){
  S.curTable=e.target.value||null;
  const arr=(S.roster[S.curTable]||[]).slice().sort((a,b)=>a.seat-b.seat);
  S.seats=arr.map(x=>({seat:toInt(x.seat), name:x.player, nation:x.nation, chips:x.chips}));
  S.activeSeatMap={}; S.seats.forEach(s=>S.activeSeatMap[s.seat]=true);
  S.folded={}; S.allin={}; S.stacks={};
  const btnDefault=toInt(S.cfg[S.curTable]?.btn_seat)||'';
  const btnSel=document.getElementById('btnSeat');
  btnSel.innerHTML=`<option value="">BTN 선택</option>${S.seats.map(s=>`<option value="${s.seat}" ${s.seat==btnDefault?'selected':''}>${seatShort(s.seat,s.name)}</option>`).join('')}`;
  S.btnSeat=btnDefault||null; S.handNo=''; document.getElementById('handNo').value='';
  S.curStreet=S.startStreetInit; resetHandState(false); renderAll();
}

/* ===== 핸드 상태 ===== */
function resetHandState(clearInputs){
  S.contrib={}; S.actions=[]; S.nextSeq=1; S.board=[]; S.holes={};
  S.pot=S.prePot; S.toCall=0; S.allin={}; S.folded={}; S.acted=new Set();
  S.curStreet=S.startStreetInit; buildTurnOrder(); renderAll();
  if(clearInputs){ document.getElementById('commitMsg').textContent='새 핸드 시작'; }
}

function buildTurnOrder(){
  const active=S.seats.map(s=>toInt(s.seat)).filter(seat=>S.activeSeatMap[seat]).sort((a,b)=>a-b);
  S.order=[]; if(!active.length){S.actorIdx=0; return;}
  const btn=toInt(S.btnSeat);
  if(S.curStreet!=='PREFLOP'){
    let start=active.findIndex(v=>v>btn); if(start===-1) start=0;
    const rotated=active.slice(start).concat(active.slice(0,start));
    const filtered=rotated.filter(v=>v!==btn); if(active.includes(btn)) filtered.push(btn);
    S.order=filtered;
  }else{
    let start=active.findIndex(v=>v>btn); if(start===-1) start=0;
    S.order=active.slice(start).concat(active.slice(0,start));
  }
  S.actorIdx=0; skipInvalidActors();
}

function skipInvalidActors(){
  if(S.order.length===0) return;
  let guard=0;
  while(guard<50){
    const seat=S.order[S.actorIdx%S.order.length];
    if(!S.activeSeatMap[seat] || S.allin[seat] || S.folded[seat]){ S.actorIdx=(S.actorIdx+1)%S.order.length; guard++; continue; }
    break;
  }
}

/* ===== 렌더 ===== */
function renderAll(){ renderSeatToggles(); renderStackGrid(); renderActionPad(); renderTurnSeat(); renderPot(); renderFeed(); syncBoardSelection('boardRowRecord'); document.getElementById('curStreetTag').textContent=S.curStreet; }

function seatShort(seat,name){
  const n=String(name||'').trim(); if(!n) return `#${seat}`;
  const parts=n.split(/\s+/); let first=parts[0]||'', last=parts.slice(1).join(' ');
  if(!last){last=first; first='';} const init=first?first[0].toUpperCase()+'.':'';
  return `#${seat} ${init}${last}`;
}
function seatNameOnly(seat,name){
  const n=String(name||'').trim(); if(!n) return `Seat ${seat}`;
  const parts=n.split(/\s+/); let first=parts[0]||'', last=parts.slice(1).join(' ');
  if(!last){last=first; first='';} const init=first?first[0].toUpperCase()+'.':'';
  return `${init}${last}`;
}

function renderSeatToggles(){
  const box=document.getElementById('seatsRow');
  if(!S.seats.length){box.innerHTML='<span class="muted small">테이블을 먼저 선택</span>'; return;}
  box.innerHTML='';
  S.seats.forEach(s=>{
    const el=document.createElement('div');
    el.className='pill '+(S.activeSeatMap[s.seat]?'active':'');
    el.textContent=seatShort(s.seat,s.name);
    el.onclick=()=>{ if(S.actions.length>0) return; S.activeSeatMap[s.seat]=!S.activeSeatMap[s.seat]; buildTurnOrder(); renderAll(); };
    box.appendChild(el);
  });
}

function renderStackGrid(){
  const grid=document.getElementById('stackGrid'); grid.innerHTML='';
  S.seats.filter(s=>S.activeSeatMap[s.seat]).forEach(s=>{
    const [c1,c2]=(S.holes[s.seat]||['','']);
    const wrap=document.createElement('div'); wrap.className='seatCard';

    // ⭐ XSS 방지: textContent 사용
    const nameContainer = document.createElement('div');
    nameContainer.className = 'small';
    const nameSpan = document.createElement('span');
    nameSpan.className = 'playerName';
    nameSpan.textContent = seatNameOnly(s.seat, s.name);
    nameContainer.appendChild(nameSpan);

    const stackRow = document.createElement('div');
    stackRow.className = 'row';
    const stackInput = document.createElement('input');
    stackInput.type = 'number';
    stackInput.placeholder = 'stack(선택)';
    stackInput.value = S.stacks[s.seat] ?? '';
    stackInput.oninput = function() { S_setStack(s.seat, this.value); };
    stackRow.appendChild(stackInput);

    const holeRow = document.createElement('div');
    holeRow.className = 'row small';
    holeRow.style.marginTop = '6px';
    const mutedSpan = document.createElement('span');
    mutedSpan.className = 'muted';
    mutedSpan.textContent = '홀카드:';
    const holeBadge = document.createElement('span');
    holeBadge.className = 'holeBadge';
    const badgeSpan = document.createElement('span');
    badgeSpan.className = 'badge click';
    badgeSpan.textContent = (prettyCard(c1)||'Card1') + '/' + (prettyCard(c2)||'Card2');
    badgeSpan.onclick = function() { openHoleOverlay(s.seat); };
    const clearBtn = document.createElement('button');
    clearBtn.type = 'button';
    clearBtn.textContent = '지우기';
    clearBtn.onclick = function() { clearHole(s.seat); };
    holeBadge.appendChild(badgeSpan);
    holeBadge.appendChild(clearBtn);
    holeRow.appendChild(mutedSpan);
    holeRow.appendChild(holeBadge);

    wrap.appendChild(nameContainer);
    wrap.appendChild(stackRow);
    wrap.appendChild(holeRow);
    grid.appendChild(wrap);
  });
}
window.S_setStack=(seat,v)=>{ S.stacks[seat]=toInt(v); };

function renderActionPad(){
  const pad=document.getElementById('actionPad'); pad.innerHTML='';
  const seat=currentActorSeat(); if(!seat){pad.innerHTML='<button type="button" disabled>대기</button>'; return;}
  const hasToCall=S.toCall>0;
  (hasToCall?['CALL','RAISE','FOLD','ALLIN']:['CHECK','BET','FOLD','ALLIN']).forEach(kind=>{
    const el=document.createElement('button'); el.type='button'; el.textContent=kind; el.onclick=()=>onAction(kind,seat); pad.appendChild(el);
  });
}
function renderTurnSeat(){ document.getElementById('turnSeat').textContent=currentActorSeat()?('Seat '+currentActorSeat()):'-'; }
function renderPot(){ document.getElementById('toCall').textContent=S.toCall; document.getElementById('pot').textContent=S.pot; }
function currentActorSeat(){ if(S.order.length===0) return null; return S.order[S.actorIdx%S.order.length]; }

function renderFeed(){
  const box=document.getElementById('actionFeed');
  if(!S.actions.length){ box.innerHTML='<span class="muted">아직 액션 없음</span>'; return; }
  box.innerHTML=S.actions.map(a=>{
    const nm = seatNameOnly(a.seat, getSeatName(a.seat));
    return `#${a.seq} · ${a.street} · ${nm} · ${a.action}${a.amount_input?(' '+a.amount_input):''} → toCall ${a.to_call_after} · pot ${a.pot_after}`;
  }).join('<br/>');
  box.scrollTop=box.scrollHeight;
}

/* ===== 액션 ===== */
function onAction(kind,seat){
  if(kind==='FOLD'){ S.folded[seat]=true; applyAction({seat,action:'FOLD',amt:0}); return; }
  if(kind==='CHECK'){ if(S.toCall>0) return; applyAction({seat,action:'CHECK',amt:0}); return; }
  if(kind==='CALL'){ const need=Math.max(0, maxContribAll()- (S.contrib[seat]||0)); applyAction({seat,action:'CALL',amt:need}); return; }
  if(kind==='BET'||kind==='RAISE'||kind==='ALLIN'){
    let def='';
    if(kind==='ALLIN' && S.stacks[seat]!=null){
      const remain = Math.max(0, S.stacks[seat] - (S.contrib[seat]||0)); def = String(remain);
    }
    const val=prompt(`금액 입력 (${kind})`, def); if(val===null) return;
    applyAction({seat,action:(kind==='ALLIN')?'ALLIN':kind,amt:toInt(val)}); return;
  }
}

function applyAction({seat,action,amt}){
  const prev=S.contrib[seat]||0; S.contrib[seat]=prev+(toInt(amt)||0);
  if(action==='ALLIN') S.allin[seat]=true;
  S.pot=S.prePot+sumObj(S.contrib);
  if(action==='BET'||action==='RAISE'||action==='ALLIN'){ S.acted=new Set([seat]); }
  else if(action==='CHECK'||action==='CALL'){ S.acted.add(seat); }
  computeToCall();
  S.actions.push({seq:S.nextSeq++,street:S.curStreet,seat,action,amount_input:toInt(amt)||0,to_call_after:S.toCall,contrib_after_seat:S.contrib[seat],pot_after:S.pot});
  advanceActor(); renderAll();
  if(isStreetComplete()){
    const nxt=nextStreet(S.curStreet);
    if(nxt){ S.curStreet=nxt; S.acted=new Set(); computeToCall(); buildTurnOrder(); renderAll(); }
  }
}

/* === toCall === */
function maxContribAll(){
  const seats=S.seats.map(x=>x.seat).filter(seat=>S.activeSeatMap[seat] && !S.folded[seat]);
  let m=0; for(const s of seats){ m=Math.max(m, S.contrib[s]||0); } return m;
}
function computeToCall(){
  const maxC=maxContribAll(); let maxNeed=0;
  for(const s of aliveNonAllin()){
    const need=Math.max(0, maxC-(S.contrib[s]||0)); if(need>maxNeed) maxNeed=need;
  }
  S.toCall=maxNeed;
}
function aliveNonAllin(){ return S.seats.map(x=>x.seat).filter(seat=>S.activeSeatMap[seat] && !S.allin[seat] && !S.folded[seat]); }
function advanceActor(){ if(S.order.length===0) return; let guard=0; do{ S.actorIdx=(S.actorIdx+1)%S.order.length; guard++; } while(guard<50 && (!S.activeSeatMap[currentActorSeat()] || S.allin[currentActorSeat()] || S.folded[currentActorSeat()])); }
function isStreetComplete(){ const alive=aliveNonAllin(); if(alive.length<=1) return true; const everyoneActed = S.acted && (S.acted.size>=alive.length); return (S.toCall===0 && everyoneActed); }
function nextStreet(st){ if(st==='PREFLOP') return 'FLOP'; if(st==='FLOP') return 'TURN'; if(st==='TURN') return 'RIVER'; return null; }
function undoOnce(){
  if(S.actions.length===0) return;
  const last=S.actions.pop(); S.nextSeq--;
  S.contrib[last.seat]=(S.contrib[last.seat]||0)-(toInt(last.amount_input)||0);
  if(S.contrib[last.seat]<0) S.contrib[last.seat]=0;
  if(last.action==='ALLIN') S.allin[last.seat]=false;
  if(last.action==='FOLD') S.folded[last.seat]=false;
  S.curStreet = S.actions.length ? S.actions[S.actions.length-1].street : S.startStreetInit;
  S.pot=S.prePot+sumObj(S.contrib); computeToCall();
  S.actorIdx=Math.max(0,S.actorIdx-1)%((S.order.length)||1);
  S.acted=new Set(S.actions.filter(a=>a.street===S.curStreet).map(a=>a.seat));
  buildTurnOrder(); renderAll();
}

/* ===== 카드 UI ===== */
function buildBoardUI(containerId, handler){
  const box=document.getElementById(containerId); box.innerHTML='';
  SUITS.forEach(s=>{
    const col=document.createElement('div'); col.className='suitCol';
    RANKS.forEach(r=>{
      const c=r+s; const el=document.createElement('div'); el.className='card';
      el.textContent=prettyCard(c); el.onclick=()=>handler(c,el); col.appendChild(el);
    });
    box.appendChild(col);
  });
}
function prettyCard(cs){
  if(!cs) return ''; const cc=cardCode(cs); const suit=cc.slice(-1), r=cc.slice(0,-1);
  const map={s:'♠',h:'♥',d:'♦',c:'♣'}; return r+map[suit];
}
function toggleBoardCard(card,el){
  const i=S.board.indexOf(card);
  if(i>=0){S.board.splice(i,1); el.classList.remove('sel'); return;}
  if(S.board.length>=5) return;
  S.board.push(card); el.classList.add('sel');
}
function syncBoardSelection(id){
  const box=document.getElementById(id); if(!box) return;
  [...box.querySelectorAll('.card')].forEach(dom=>{
    const c=labelToCode(dom.textContent);
    if(S.board.includes(c)) dom.classList.add('sel'); else dom.classList.remove('sel');
  });
}
function labelToCode(label){
  const r=label.replace(/[♠♥♦♣]/,'').trim();
  const sMap={'♠':'s','♥':'h','♦':'d','♣':'c'}; const sym=label.slice(-1);
  return r + (sMap[sym]||'');
}

/* 홀카드 오버레이(2장 연속 선택) — 보드중복 차단(단방향) */
function openHoleOverlay(seat){
  S.holePickSeat=seat;
  document.getElementById('ovTitle').textContent=`${seatNameOnly(seat, getSeatName(seat))} · 홀카드`;
  updateOvCount_(seat);
  document.getElementById('overlay').style.display='flex';
}
function pickCardOverlay(card,el){
  if(!S.holePickSeat) return;
  // 보드에 이미 있는 카드는 홀카드에서 선택 불가(요청사항 v1.1)
  if(S.board.includes(card)){ return; }

  const seat=S.holePickSeat;
  const arr=S.holes[seat]||['',''];
  const existsIdx = arr.indexOf(card);
  if(existsIdx>=0){ arr[existsIdx]=''; }
  else{
    if(!arr[0]) arr[0]=card;
    else if(!arr[1]) arr[1]=card;
    else { arr[0]=arr[1]; arr[1]=card; }
  }
  S.holes[seat]=arr; renderStackGrid(); updateOvCount_(seat);
  if(arr[0] && arr[1]) closeOverlay();
}
function updateOvCount_(seat){
  const arr=S.holes[seat]||['','']; const n=(arr[0]?1:0)+(arr[1]?1:0);
  document.getElementById('ovCount').textContent=` · 선택 ${n}/2`;
}
function clearHole(seat){ S.holes[seat]=['','']; renderStackGrid(); }
function closeOverlay(){ document.getElementById('overlay').style.display='none'; S.holePickSeat=null; }

/* ===== 커밋/리뷰 ===== */
function commitHand(){
  saveSettings_();
  const payload={
    client_uuid: uuid(),
    event_id:'',
    table_id:S.curTable||'',
    hand_no:(S.handNo||''),
    start_street:S.startStreetInit,
    started_at:new Date().toISOString(),
    ended_at:'',
    btn_seat:S.btnSeat||'',
    board:getBoardObjectForSave(),
    pre_pot:S.prePot||'',
    winner_seat:'',
    pot_final:'',
    actions:S.actions.map(x=>Object.assign({},x)),
    holes:S.holes,
    stack_snapshot:S.stacks
  };
  const msg=document.getElementById('commitMsg'); msg.textContent='저장 중…';
  const ext = { sheetId: (S.extSheetId||'').trim(), bb: S.bbValue||0 };
  google.script.run
    .withSuccessHandler(res=>{
      const extInfo = res && res.external && res.external.updated ? ` · 외부시트 row ${res.external.row} 갱신` :
        (res && res.external && res.external.reason ? ` · 외부시트 스킵(${res.external.reason})` : '');
      msg.textContent=`완료: #${res.hand_no||'-'} (${res.hand_id})${extInfo}`;
      resetHandState(true); loadList();
    })
    .withFailureHandler(err=>{ msg.textContent='오류: '+(err.message||err); })
    .saveHandWithExternal(payload, ext);
}
function getBoardObjectForSave(){
  const b=[...S.board]; // [f1,f2,f3,turn,river]
  return {f1:b[0]||'',f2:b[1]||'',f3:b[2]||'',turn:b[3]||'',river:b[4]||''};
}

/* === Review 상태 관리 (v1.2.0) === */
const reviewState={page:1,size:10,total:0,loading:false,hasMore:true,selectedId:null};

function loadList(reset){
  if(reset){ reviewState.page=1; reviewState.hasMore=true; reviewState.total=0; }
  if(reviewState.loading||!reviewState.hasMore) return;
  reviewState.loading=true;
  const box=document.getElementById('list');
  if(reset) box.innerHTML='<div class="small muted" style="padding:8px">불러오는 중…</div>';
  google.script.run.withSuccessHandler(data=>{
    reviewState.loading=false;
    if(data.error){ box.innerHTML=`<div class="small" style="color:#ffbdbd">오류: ${data.error}</div>`; return; }
    reviewState.total=data.total;
    document.getElementById('listInfo').textContent=`총 ${reviewState.total}건 (${reviewState.page}페이지)`;
    if(reset) box.innerHTML='';
    if(!data.items||data.items.length===0){ reviewState.hasMore=false; return; }
    data.items.forEach(it=>box.appendChild(createListItem(it)));
    reviewState.page++;
    reviewState.hasMore=(box.children.length<reviewState.total);
  }).withFailureHandler(err=>{
    reviewState.loading=false;
    box.innerHTML=`<div class="small" style="color:#ffbdbd">로드 오류: ${(err.message||err)}</div>`;
  }).queryHands({},{num:reviewState.page,size:reviewState.size});
}

function createListItem(it){
  const div=document.createElement('div'); div.className='seatCard'; div.dataset.handId=it.hand_id;
  const arr=boardToArray(it.board||it)||[];
  const boardBadgesHTML=arr.slice(0,3).map(cs=>renderCardBadge(cs,'small')).join('')+(arr.length>3?'...':'');

  div.innerHTML=`
    <div><b>#${it.hand_no||'-'}</b> · Table ${it.table_id||'-'} · BTN ${it.btn_seat||'-'} · <span class="badge">${it.start_street||'-'}</span></div>
    <div class="small muted">${it.started_at||''}</div>
    <div class="boardSmall">${boardBadgesHTML||'<span class="muted">-</span>'}</div>`;
  div.onclick=()=>selectAndLoadDetail(it.hand_id,div);
  return div;
}

function selectAndLoadDetail(id,el){
  document.querySelectorAll('#list .seatCard').forEach(d=>d.classList.remove('selected'));
  el.classList.add('selected');
  reviewState.selectedId=id;
  loadDetail(id);
}

/* 상세 */
function loadDetail(id){
  const dc = document.getElementById('detailContent');
  const vBtn = document.getElementById('virtualBtnContainer');
  if (!id || String(id).trim() === '') { dc.innerHTML = `<div class="small" style="color:#ffbdbd">잘못된 hand id</div>`; vBtn.classList.add('hidden'); return; }
  dc.textContent = '상세 불러오는 중…';
  vBtn.classList.add('hidden');
  google.script.run
    .withSuccessHandler(x=>{
      try{
        if (!x) { dc.innerHTML = `<div class="small" style="color:#ffbdbd">서버 응답 없음(undefined) · id=${id}</div>`; return; }
        if (x.error) { dc.innerHTML = `<div class="small" style="color:#ffbdbd">오류: ${x.error} · id=${id}</div>`; return; }
        const head = (x.head && typeof x.head === 'object') ? x.head : {};
        const acts = Array.isArray(x.acts) ? x.acts : (Array.isArray(x.actions) ? x.actions : []);
        const stacks = safeJson_(head.stacks_json||{});
        if (!Object.keys(head).length) {
          const sample = JSON.stringify(x).slice(0,400);
          dc.innerHTML = `<div class="small" style="color:#ffbdbd">형식 오류(빈 head) · id=${id}<br/><code>${sample}</code></div>`;
          return;
        }
        dc.innerHTML = renderDetailContent(head, acts);

        // VIRTUAL 전송 버튼 표시
        vBtn.classList.remove('hidden');
        document.getElementById('virtualMsg').textContent = '';
      }catch(err){
        const msg=(err && (err.message||err.toString()))||'unknown';
        dc.innerHTML = `<div class="small" style="color:#ffbdbd">클라이언트 렌더 오류: ${msg} · id=${id}</div>`;
      }
    })
    .withFailureHandler(err=>{
      const msg = (err && (err.message || err.toString())) || 'unknown failure';
      dc.innerHTML = `<div class="small" style="color:#ffbdbd">로드 실패: ${msg} · id=${id}</div>`;
    })
    .getHandDetail(id);
}

/* === VIRTUAL 시트 전송 (v2.4) === */
function pushToVirtualSheet(){
  const handId = reviewState.selectedId;
  if(!handId){ alert('핸드를 먼저 선택하세요'); return; }

  const sheetId = S.extSheetId || localStorage.getItem('phl_extSheetId') || '';
  if(!sheetId){ alert('VIRTUAL 시트 ID를 설정해주세요 (설정 메뉴)'); return; }

  const bb = S.bbValue || toInt(localStorage.getItem('phl_bbSize')) || 0;
  const msg = document.getElementById('virtualMsg');
  const btn = document.getElementById('pushVirtualBtn');

  btn.disabled = true;
  msg.textContent = '전송 중...';
  msg.style.color = '#ffdb4d';

  google.script.run
    .withSuccessHandler(res=>{
      btn.disabled = false;
      if(res.success){
        const dupMsg = res.idempotent ? ' (이미 전송됨)' : '';
        msg.textContent = `✅ 전송 완료! (행: ${res.row}, 파일명: ${res.fileName})${dupMsg}`;
        msg.style.color = '#b3ffb3';
      }else{
        msg.textContent = `⚠️ 전송 실패: ${res.error || 'unknown'}`;
        msg.style.color = '#ffbdbd';
      }
    })
    .withFailureHandler(err=>{
      btn.disabled = false;
      msg.textContent = `❌ 오류: ${err.message || err}`;
      msg.style.color = '#ffbdbd';
    })
    .pushToVirtual(handId, sheetId, bb);
}

/* ===== Review 렌더 유틸 ===== */
function cardCode(cs){
  if (!cs) return '';
  if (typeof cs === 'string') return cs.trim();
  if (cs.card) return String(cs.card).trim();
  if (cs.rank && cs.suit){
    const r = String(cs.rank).toUpperCase().replace('10','T');
    const map={spade:'s',heart:'h',diamond:'d',club:'c','S':'s','H':'h','D':'d','C':'c'};
    const sRaw=String(cs.suit); const s=map[sRaw]||map[sRaw.toLowerCase()]||sRaw.toLowerCase();
    return r+s;
  }
  if (Array.isArray(cs) && cs.length>=2){
    const r=String(cs[0]).toUpperCase().replace('10','T');
    const s=String(cs[1]).toLowerCase(); return r+s;
  }
  return '';
}
function boardToArray(b){
  if(!b) return [];
  if(Array.isArray(b)) return b.map(cardCode).filter(Boolean);
  // 서버 응답 포맷: {f1,f2,f3,turn,river} 또는 {board_f1,board_f2,...}
  const keys=['f1','f2','f3','turn','river'].map(k=>cardCode(b[k])).filter(Boolean);
  if(keys.length) return keys;
  const keys2=['board_f1','board_f2','board_f3','board_turn','board_river'].map(k=>cardCode(b[k])).filter(Boolean);
  return keys2.length?keys2:(b.board?boardToArray(b.board):[]);
}
function boardBadges(b){
  const arr=boardToArray(b); if(!arr.length) return '<span class="muted">-</span>';
  return `<div style="display:flex;gap:10px;flex-wrap:wrap">${arr.map(cs=>renderCardBadge(cs)).join('')}</div>`;
}
function getSeatName(seat){
  const s = (S.roster[S.curTable]||[]).find(x=>toInt(x.seat)===toInt(seat));
  return s?.player || `Seat ${seat}`;
}
function seatNameOnlyFmt(seat){ return seatNameOnly(seat, getSeatName(seat)); }
function groupByStreet(acts){
  const g={PREFLOP:[],FLOP:[],TURN:[],RIVER:[]};
  (acts||[]).forEach(a=>{ const s=(a.street||'').toUpperCase(); if(g[s]) g[s].push(a); else g.RIVER.push(a); });
  return g;
}
function formatStreetSection(title,arr,tableId){
  if(!arr||!arr.length) return '';

  const sectionDiv = document.createElement('div');

  const titleDiv = document.createElement('div');
  titleDiv.className = 'streetTitle';
  titleDiv.textContent = title;
  sectionDiv.appendChild(titleDiv);

  const badgeRow = document.createElement('div');
  badgeRow.className = 'badgeRow';

  arr.forEach(a => {
    const fullName=getSeatNameByTable(tableId,a.seat);
    const name=seatNameOnly(a.seat,fullName);
    const amt=a.amount_input?` ${a.amount_input}`:'';
    const k=(a.action||'').toUpperCase();
    const cl=k==='CHECK'?'act-chk':k==='CALL'?'act-call':k==='BET'?'act-bet':k==='RAISE'?'act-raise':k==='ALLIN'?'act-allin':'act-fold';

    // ⭐ XSS 방지: name을 textContent로
    const badge = document.createElement('span');
    badge.className = `actBadge ${cl}`;
    badge.textContent = `${name} ${a.action}${amt} · pot ${a.pot_after}`;
    badgeRow.appendChild(badge);
  });

  sectionDiv.appendChild(badgeRow);
  return sectionDiv.outerHTML;
}
/* === Review 상세 렌더링 헬퍼 (v1.2.1) === */
function renderCardBadge(cs,size='large'){
  const cc=cardCode(cs); if(!cc) return '';
  const suit=cc.slice(-1), r=cc.slice(0,-1);
  const sym=suit==='s'?'♠':suit==='h'?'♥':suit==='d'?'♦':'♣';
  const cl=suit==='s'?'cb-s':suit==='h'?'cb-h':suit==='d'?'cb-d':'cb-c';
  const sizeClass=size==='small'?'cardBadgeSmall':'cardBadge';
  return `<span class="${sizeClass} ${cl}">${r}${sym}</span>`;
}

function calculateFinalPot(head,acts){
  if(head.pot_final) return toInt(head.pot_final);
  let maxPot=0;
  (acts||[]).forEach(a=>{const val=toInt(a.pot_after); if(val>maxPot) maxPot=val;});
  return maxPot||toInt(head.pre_pot)||0;
}

function formatPotWithBB(pot,bb){
  pot=toInt(pot);
  if(!bb||bb===0) return pot.toLocaleString();
  const bbVal=(pot/bb).toFixed(1);
  return `${pot.toLocaleString()} (${bbVal}BB)`;
}

function renderPotHeader(head,acts){
  const pot=calculateFinalPot(head,acts);
  const bb=toInt(localStorage.getItem('phl_bbSize')||0);
  return `<div class="potHeader">
    <div><b>핸드 #${head.hand_no||'-'}</b></div>
    <div><b>팟: ${formatPotWithBB(pot,bb)}</b></div>
  </div>`;
}

function getSeatNameByTable(tableId,seat){
  const roster=S.roster[tableId]||[];
  const s=roster.find(x=>toInt(x.seat)===toInt(seat));
  return s?.player || `Seat ${seat}`;
}

function renderPlayerRows(head){
  const stacks=safeJson_(head.stacks_json||'{}');
  const holes=safeJson_(head.holes_json||'{}');
  const btnSeat=toInt(head.btn_seat);
  const tableId=head.table_id;
  const seats=Object.keys(stacks).sort((a,b)=>toInt(a)-toInt(b));
  if(!seats.length) return '';

  const playerSection = document.createElement('div');
  playerSection.className = 'playerSection';

  const divider1 = document.createElement('div');
  divider1.className = 'sectionDivider';
  playerSection.appendChild(divider1);

  seats.forEach(s => {
    const seat=toInt(s);
    const fullName=getSeatNameByTable(tableId,seat);
    const name=seatNameOnly(seat,fullName);
    const pos=(seat===btnSeat)?' (BTN)':'';
    const holeCards=holes[s]||[];
    const stack=stacks[s]?toInt(stacks[s]).toLocaleString():'-';

    const playerRow = document.createElement('div');
    playerRow.className = 'playerRow';

    // ⭐ XSS 방지: playerName을 textContent로
    const nameSpan = document.createElement('span');
    nameSpan.className = 'playerName';
    nameSpan.textContent = name + pos;
    playerRow.appendChild(nameSpan);

    const holeSpan = document.createElement('span');
    holeSpan.className = 'playerHole';
    if(holeCards[0] && holeCards[1]) {
      holeSpan.innerHTML = renderCardBadge(holeCards[0]) + renderCardBadge(holeCards[1]);
    } else {
      const mutedSpan = document.createElement('span');
      mutedSpan.className = 'muted';
      mutedSpan.textContent = '-';
      holeSpan.appendChild(mutedSpan);
    }
    playerRow.appendChild(holeSpan);

    const stackSpan = document.createElement('span');
    stackSpan.className = 'playerStack';
    stackSpan.textContent = stack;
    playerRow.appendChild(stackSpan);

    playerSection.appendChild(playerRow);
  });

  const divider2 = document.createElement('div');
  divider2.className = 'sectionDivider';
  playerSection.appendChild(divider2);

  return playerSection.outerHTML;
}

function renderPotFooter(head,acts){
  const pot=calculateFinalPot(head,acts);
  const bb=toInt(localStorage.getItem('phl_bbSize')||0);
  return `<div class="sectionDivider"></div>
    <div class="potFooter">최종 팟: ${formatPotWithBB(pot,bb)}</div>`;
}

function renderDetailContent(head,acts){
  const b=head.board||head||{}; const g=groupByStreet(acts||[]);
  const tableId=head.table_id;

  const container = document.createElement('div');

  // Pot Header
  const potHeaderDiv = document.createElement('div');
  potHeaderDiv.innerHTML = renderPotHeader(head,acts);
  container.appendChild(potHeaderDiv);

  // Hand ID
  const handIdDiv = document.createElement('div');
  handIdDiv.className = 'small muted';
  handIdDiv.textContent = head.hand_id || '';
  container.appendChild(handIdDiv);

  // Table Info (⭐ XSS 방지: tableId를 textContent로)
  const tableInfoDiv = document.createElement('div');
  tableInfoDiv.className = 'small';
  tableInfoDiv.appendChild(document.createTextNode('Table '));
  const tableIdSpan = document.createElement('span');
  tableIdSpan.textContent = tableId || '-';
  tableInfoDiv.appendChild(tableIdSpan);
  tableInfoDiv.appendChild(document.createTextNode(' · BTN '));
  const btnSpan = document.createElement('span');
  btnSpan.textContent = head.btn_seat || '-';
  tableInfoDiv.appendChild(btnSpan);
  tableInfoDiv.appendChild(document.createTextNode(' · '));
  const startStreetB = document.createElement('b');
  startStreetB.textContent = '시작: ' + (head.start_street || '-');
  tableInfoDiv.appendChild(startStreetB);
  container.appendChild(tableInfoDiv);

  // Board Section
  const boardSection = document.createElement('div');
  boardSection.className = 'boardSection';
  const boardLabel = document.createElement('div');
  boardLabel.className = 'small muted';
  boardLabel.textContent = '보드';
  boardSection.appendChild(boardLabel);
  const boardBadgesDiv = document.createElement('div');
  boardBadgesDiv.innerHTML = boardBadges(b); // 카드 HTML은 제어된 함수이므로 유지
  boardSection.appendChild(boardBadgesDiv);
  container.appendChild(boardSection);

  // Player Rows
  const playerRowsDiv = document.createElement('div');
  playerRowsDiv.innerHTML = renderPlayerRows(head); // 내부에서 name XSS 수정 필요
  container.appendChild(playerRowsDiv);

  // Street Sections
  const streets = ['PREFLOP','FLOP','TURN','RIVER'];
  streets.forEach(st => {
    const sectionDiv = document.createElement('div');
    sectionDiv.innerHTML = formatStreetSection(st, g[st], tableId); // 내부에서 name XSS 수정 필요
    container.appendChild(sectionDiv);
  });

  // Pot Footer
  const potFooterDiv = document.createElement('div');
  potFooterDiv.innerHTML = renderPotFooter(head,acts);
  container.appendChild(potFooterDiv);

  return container.innerHTML;
}

/* ===== 유틸 ===== */
function sumObj(o){ return Object.values(o||{}).reduce((a,b)=>a+(toInt(b)||0),0); }
function toInt(v){ const n=parseInt(v,10); return isNaN(n)?0:n; }
function uuid(){ return ([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g,c=>(c^crypto.getRandomValues(new Uint8Array(1))[0]&15>>c/4).toString(16)); }
function safeJson_(s){ try{return typeof s==='string'?JSON.parse(s||'{}'):(s||{});}catch(e){return {}} }
</script>

<script>
/* ========== Tracker JavaScript ========== */

/* ===== State ===== */
let currentView = 'key'; // 'key' | 'table'
let currentTableId = null;
let keyPlayers = [];

/* ===== Init ===== */
// window.onload 제거됨 (탭 진입시 초기화)

/* ===== View Switching ===== */
function showKeyPlayerView() {
  document.getElementById('viewKeyPlayers').classList.remove('hidden');
  document.getElementById('viewTable').classList.add('hidden');
  currentView = 'key';
  currentTableId = null;
}

function showTableView(tableId) {
  document.getElementById('viewKeyPlayers').classList.add('hidden');
  document.getElementById('viewTable').classList.remove('hidden');
  document.getElementById('tableTitle').textContent = tableId;
  currentView = 'table';
  currentTableId = tableId;
  loadTablePlayers(tableId);
}

/* ===== Key Player View ===== */
function loadKeyPlayers() {
  const list = document.getElementById('keyPlayerList');
  list.innerHTML = '<div class="loading">로딩 중...</div>';

  google.script.run
    .withSuccessHandler(players => {
      keyPlayers = players;
      renderKeyPlayers(players);
    })
    .withFailureHandler(err => {
      list.innerHTML = `<div class="error">에러: ${err.message}</div>`;
    })
    .tracker_getKeyPlayers();
}

function renderKeyPlayers(players) {
  const list = document.getElementById('keyPlayerList');
  const count = document.getElementById('keyCount');

  if (players.length === 0) {
    list.innerHTML = '<div class="muted small">키 플레이어가 없습니다.</div>';
    count.textContent = '0';
    return;
  }

  list.innerHTML = '';
  count.textContent = players.length;

  players.forEach(p => {
    const card = document.createElement('div');
    card.className = 'keyPlayerCard';

    const chipChange = getChipChange(p.tableNo, p.seatNo, p.chips);
    const changeHTML = chipChange.amount !== 0
      ? `<span class="chipChange ${chipChange.direction}">${chipChange.text}</span>`
      : '';

    card.innerHTML = `
      <div class="cardHeader">
        <span class="tableLabel">${p.tableNo}</span>
        <span class="playerName">${p.player} (${p.seatNo})</span>
        <span class="flag">${getFlag(p.nation)}</span>
      </div>
      <div class="chipRow">
        <span class="chips" onclick="editChips('${p.tableNo}', '${p.seatNo}', ${p.chips}, '${p.player}')">${formatChips(p.chips)}</span>
        ${changeHTML}
      </div>
      <button class="manageBtn" onclick="showTableView('${p.tableNo}')">${p.tableNo} 관리</button>
    `;

    list.appendChild(card);
  });
}

/* ===== Table View ===== */
function loadTablePlayers(tableId) {
  const list = document.getElementById('tablePlayerList');
  list.innerHTML = '<div class="loading">로딩 중...</div>';

  google.script.run
    .withSuccessHandler(players => {
      renderTablePlayers(tableId, players);
    })
    .withFailureHandler(err => {
      list.innerHTML = `<div class="error">에러: ${err.message}</div>`;
    })
    .tracker_getTablePlayers(tableId);
}

function renderTablePlayers(tableId, players) {
  const list = document.getElementById('tablePlayerList');
  list.innerHTML = '';

  players.forEach(p => {
    const row = document.createElement('div');
    row.className = 'playerRow';

    if (p.empty) {
      row.innerHTML = `
        <span class="seat">${p.seatNo}</span>
        <span class="emptySeat">(빈 좌석)</span>
        <button class="addBtn" onclick="addPlayerPrompt('${tableId}', '${p.seatNo}')">[+]</button>
      `;
    } else {
      const keyStar = p.keyplayer ? '<span class="keyStar">⭐</span>' : '';
      row.innerHTML = `
        <span class="seat">${p.seatNo}</span>
        <span class="name">${p.player}${keyStar}</span>
        <span class="flag">${getFlag(p.nation)}</span>
        <span class="chips" onclick="editChips('${tableId}', '${p.seatNo}', ${p.chips}, '${p.player}')">${formatChips(p.chips)}</span>
        <button class="deleteBtn" onclick="deletePlayerConfirm('${tableId}', '${p.seatNo}', '${p.player}')">🗑️</button>
      `;
    }

    list.appendChild(row);
  });
}

/* ===== Edit Chips ===== */
function editChips(tableId, seatNo, currentChips, playerName) {
  const overlay = document.getElementById('overlay');
  const content = document.getElementById('overlayContent');

  content.innerHTML = `
    <div class="overlayTitle">${seatNo} ${playerName} 칩 수정</div>
    <div class="muted small">현재: ${formatChips(currentChips)}</div>
    <input type="text" id="chipInput" class="overlayInput" placeholder="예: 750000 또는 750k" autocomplete="off" inputmode="decimal">
    <div class="overlayActions">
      <button class="btnCancel" onclick="closeOverlay()">취소</button>
      <button class="btnConfirm" onclick="confirmEditChips('${tableId}', '${seatNo}', ${currentChips})">확인</button>
    </div>
  `;

  overlay.classList.add('show');
  setTimeout(() => document.getElementById('chipInput').focus(), 100);
}

function confirmEditChips(tableId, seatNo, oldChips) {
  const input = document.getElementById('chipInput').value.trim();
  if (!input) {
    alert('칩을 입력하세요.');
    return;
  }

  const newChips = parseChips(input);
  if (newChips === null || newChips < 0) {
    alert('올바른 숫자를 입력하세요 (예: 750000 또는 750k)');
    return;
  }

  closeOverlay();
  showLoading();

  google.script.run
    .withSuccessHandler(() => {
      saveChipHistory(tableId, seatNo, newChips);
      if (currentView === 'key') {
        loadKeyPlayers();
      } else {
        loadTablePlayers(currentTableId);
      }
    })
    .withFailureHandler(err => {
      alert(`에러: ${err.message}`);
      hideLoading();
    })
    .tracker_updatePlayerChips(tableId, seatNo, newChips);
}

/* ===== Add Player ===== */
function addPlayerPrompt(tableId, seatNo) {
  const overlay = document.getElementById('overlay');
  const content = document.getElementById('overlayContent');

  content.innerHTML = `
    <div class="overlayTitle">${seatNo} 플레이어 추가</div>
    <input type="text" id="nameInput" class="overlayInput" placeholder="이름" autocomplete="off">
    <select id="nationInput" class="overlayInput">
      <option value="KR">🇰🇷 KR</option>
      <option value="US">🇺🇸 US</option>
      <option value="JP">🇯🇵 JP</option>
      <option value="CN">🇨🇳 CN</option>
      <option value="GB">🇬🇧 GB</option>
      <option value="FR">🇫🇷 FR</option>
      <option value="DE">🇩🇪 DE</option>
      <option value="CA">🇨🇦 CA</option>
      <option value="AU">🇦🇺 AU</option>
      <option value="TW">🇹🇼 TW</option>
    </select>
    <input type="text" id="chipsInput" class="overlayInput" placeholder="칩 (예: 280000 또는 280k)" autocomplete="off" inputmode="decimal">
    <label style="display:flex;align-items:center;gap:var(--sp-sm);margin-bottom:var(--sp-md)">
      <input type="checkbox" id="keyInput" style="width:20px;height:20px">
      <span>키 플레이어로 등록</span>
    </label>
    <div class="overlayActions">
      <button class="btnCancel" onclick="closeOverlay()">취소</button>
      <button class="btnConfirm" onclick="confirmAddPlayer('${tableId}', '${seatNo}')">추가</button>
    </div>
  `;

  overlay.classList.add('show');
  setTimeout(() => document.getElementById('nameInput').focus(), 100);
}

function confirmAddPlayer(tableId, seatNo) {
  const name = document.getElementById('nameInput').value.trim();
  const nation = document.getElementById('nationInput').value;
  const chipsInput = document.getElementById('chipsInput').value.trim();
  const isKey = document.getElementById('keyInput').checked;

  if (!name) {
    alert('이름을 입력하세요.');
    return;
  }
  if (!chipsInput) {
    alert('칩을 입력하세요.');
    return;
  }

  const chips = parseChips(chipsInput);
  if (chips === null || chips < 0) {
    alert('올바른 칩 숫자를 입력하세요.');
    return;
  }

  closeOverlay();
  showLoading();

  google.script.run
    .withSuccessHandler(() => {
      if (currentView === 'key' && isKey) {
        loadKeyPlayers();
      } else {
        loadTablePlayers(currentTableId);
      }
    })
    .withFailureHandler(err => {
      alert(`에러: ${err.message}`);
      hideLoading();
    })
    .tracker_addPlayer(tableId, seatNo, name, nation, chips, isKey);
}

/* ===== Delete Player ===== */
function deletePlayerConfirm(tableId, seatNo, playerName) {
  if (!confirm(`${seatNo} ${playerName} 삭제하시겠습니까?`)) return;

  showLoading();

  google.script.run
    .withSuccessHandler(() => {
      if (currentView === 'key') {
        loadKeyPlayers();
      } else {
        loadTablePlayers(currentTableId);
      }
    })
    .withFailureHandler(err => {
      alert(`에러: ${err.message}`);
      hideLoading();
    })
    .tracker_removePlayer(tableId, seatNo);
}

/* ===== Utilities ===== */
function parseChips(input) {
  if (!input) return null;
  const str = String(input).trim().toLowerCase();
  if (str.endsWith('k')) {
    const num = parseFloat(str.slice(0, -1));
    return isNaN(num) ? null : Math.round(num * 1000);
  }
  const num = parseFloat(str.replace(/[^\d.]/g, ''));
  return isNaN(num) ? null : Math.round(num);
}

function formatChips(chips) {
  if (chips >= 1000) {
    return Math.round(chips / 1000) + 'k';
  }
  return chips.toString();
}

function getFlag(nationCode) {
  const flags = {
    'KR': '🇰🇷', 'US': '🇺🇸', 'JP': '🇯🇵', 'CN': '🇨🇳', 'GB': '🇬🇧',
    'FR': '🇫🇷', 'DE': '🇩🇪', 'CA': '🇨🇦', 'AU': '🇦🇺', 'TW': '🇹🇼'
  };
  return flags[nationCode] || '🌐';
}

function getChipChange(tableId, seatNo, currentChips) {
  const key = `${tableId}_${seatNo}`;
  const history = JSON.parse(localStorage.getItem('phl_chipHistory') || '{}');
  const oldChips = history[key] || currentChips;

  const diff = currentChips - oldChips;
  if (diff > 0) {
    return { amount: diff, direction: 'up', text: `↑${formatChips(diff)}` };
  } else if (diff < 0) {
    return { amount: diff, direction: 'down', text: `↓${formatChips(Math.abs(diff))}` };
  } else {
    return { amount: 0, direction: 'same', text: '' };
  }
}

function saveChipHistory(tableId, seatNo, chips) {
  const key = `${tableId}_${seatNo}`;
  const history = JSON.parse(localStorage.getItem('phl_chipHistory') || '{}');
  history[key] = chips;
  localStorage.setItem('phl_chipHistory', JSON.stringify(history));
}

function closeOverlay() {
  document.getElementById('overlay').classList.remove('show');
}

function showLoading() {
  const list = currentView === 'key'
    ? document.getElementById('keyPlayerList')
    : document.getElementById('tablePlayerList');
  list.innerHTML = '<div class="loading">처리 중...</div>';
}

function hideLoading() {
  // 리렌더링으로 처리됨
}


/* ========== SoftSender JavaScript ========== */

  const LS_KEYS = { CUE:'SCS_CUE_ID', TYPE:'SCS_TYPE_ID' };

  // 상수 정의
const CONSTANTS = {
  TOAST_DURATION: 1800,
  DEFAULT_SEAT_INDEX: 1,
  DEBOUNCE_DELAY: 300,
  MODES: {
    PU: 'PU',
    ELIM: 'ELIM',
    L3: 'L3',
    LEADERBOARD: 'LEADERBOARD'
  },
  DISPLAY: {
    GRID: 'grid',
    BLOCK: 'block',
    NONE: 'none'
  }
};

const state = {
  mode: CONSTANTS.MODES.ELIM,
  tz: 'Asia/Seoul',
  typeRows: [],
  byRoom: {},
  byRoomTable: {},
  tableList: [],     // Room+Table 통합 목록
  timeCenter: '',
  cueId: '',
  typeId: '',
  batch: []          // 배치 전송용 배열
};

  function toast(msg, ok=true){
  const t=document.getElementById('toast');
  t.textContent=msg; t.className='show'+(ok?'':' err');
  setTimeout(()=>t.className='', CONSTANTS.TOAST_DURATION);
}
function setStatus(s){ document.getElementById('status').textContent=s; }

/* ===== Sheet ID 저장/초기화 ===== */
function loadIdsFromLocal(){
  const cue = localStorage.getItem(LS_KEYS.CUE) || '';
  const type= localStorage.getItem(LS_KEYS.TYPE) || '';
  if (cue) document.getElementById('cueId').value = cue;
  if (type) document.getElementById('typeId').value = type;
  state.cueId = cue;
  state.typeId= type;
  renderIdsHint();
}
function saveIds(){
  const cue = document.getElementById('cueId').value.trim();
  const type= document.getElementById('typeId').value.trim();
  if (cue) localStorage.setItem(LS_KEYS.CUE, cue); else localStorage.removeItem(LS_KEYS.CUE);
  if (type) localStorage.setItem(LS_KEYS.TYPE, type); else localStorage.removeItem(LS_KEYS.TYPE);
  state.cueId = cue; state.typeId = type;
  renderIdsHint();
  toast('ID 저장 완료');
  reloadSheets();
}
function clearIds(){
  localStorage.removeItem(LS_KEYS.CUE);
  localStorage.removeItem(LS_KEYS.TYPE);
  state.cueId=''; state.typeId='';
  document.getElementById('cueId').value='';
  document.getElementById('typeId').value='';
  renderIdsHint();
  toast('ID 초기화 완료(기본값 사용)');
  reloadSheets();
}
function renderIdsHint(){
  const c = state.cueId ? `CUE=${state.cueId}` : 'CUE=기본값';
  const t = state.typeId? `TYPE=${state.typeId}`: 'TYPE=기본값';
  document.getElementById('idsHint').textContent = `현재 사용 중: ${c} | ${t}`;
}

/* 인덱싱 */
function indexTypeRows(rows){
  state.byRoom={}; state.byRoomTable={}; state.tableList=[];
  rows.forEach(r=>{
    (state.byRoom[r.room] ||= []).push(r);
    const key = r.room + '|' + r.tno;
    (state.byRoomTable[key] ||= []).push(r);
  });

  // Room+Table 통합 목록 생성
  Object.keys(state.byRoomTable).forEach(key => {
    const [room, tno] = key.split('|');
    const tname = state.byRoomTable[key][0]?.tname || '';
    state.tableList.push({
      key,
      label: tname ? `${room} - ${tname} (Table ${tno})` : `${room} - Table ${tno}`,
      room,
      tno
    });
  });

  // 정렬: Room → Table No.
  state.tableList.sort((a,b) => {
    if (a.room !== b.room) return a.room.localeCompare(b.room);
    return Number(a.tno) - Number(b.tno);
  });
}
function normSeat(s){
  const t = String(s||'').trim();
  if(!t) return '';
  const n = t.replace(/\s/g,'').replace(/^#?/,'');
  return '#'+n;
}

/* 플레이어 조회 헬퍼 함수 */
function findPlayerBySeat(key, seat) {
  if (!key || !seat) return null;
  const arr = state.byRoomTable[key] || [];
  return arr.find(r => normSeat(r.seat) === normSeat(seat));
}

/* ===== UI 채우기 ===== */
function fillRoomTables(){
  const sel = document.getElementById('selRoomTable');
  sel.innerHTML = '<option value="">-</option>';

  const fragment = document.createDocumentFragment();
  state.tableList.forEach(t => {
    const o = document.createElement('option');
    o.value = t.key;
    o.textContent = t.label;
    fragment.appendChild(o);
  });
  sel.appendChild(fragment);

  if (sel.options.length > 1) sel.selectedIndex = CONSTANTS.DEFAULT_SEAT_INDEX;
  fillSeats();
}

function fillSeats(){
  const key = document.getElementById('selRoomTable').value;
  const selSeat = document.getElementById('selSeat');
  const prevSeat = selSeat.value;

  selSeat.innerHTML = '<option value="">좌석 선택</option>';

  if (!key) return;

  const arr = state.byRoomTable[key] || [];

  // Seat 드롭다운: "#1 - John Doe" 형식
  const seats = [...new Set(arr.map(r => normSeat(r.seat)))]
    .sort((a,b) => Number(a.replace('#','')) - Number(b.replace('#','')));

  const fragment = document.createDocumentFragment();
  seats.forEach(s => {
    const player = findPlayerBySeat(key, s);
    const o = document.createElement('option');
    o.value = s;
    o.textContent = `${s} - ${player?.player || ''}`;
    fragment.appendChild(o);
  });
  selSeat.appendChild(fragment);

  const idx = seats.indexOf(prevSeat);
  selSeat.selectedIndex = idx >= 0 ? idx + CONSTANTS.DEFAULT_SEAT_INDEX : (seats.length > 0 ? CONSTANTS.DEFAULT_SEAT_INDEX : 0);

  applyPickFromSeat();
  if(state.mode===CONSTANTS.MODES.LEADERBOARD) buildLeaderboardList();
  rebuildFileName();
}

function applyPickFromSeat(){
  const key = document.getElementById('selRoomTable').value;
  const seat = document.getElementById('selSeat').value;
  const pick = findPlayerBySeat(key, seat);

  if (pick){
    document.getElementById('countryCode').value = pick.nat || '';
  }
  rebuildPreview();
  rebuildFileName();
}

/* 시간 옵션 */
function fillTimes(list, center){
  const sel = document.getElementById('selTime');
  sel.innerHTML = '<option value="">(미선택: 현재시각)</option>';

  const fragment = document.createDocumentFragment();
  list.forEach(v=>{
    const o=document.createElement('option');
    o.value=v; o.textContent = (v===center)? `${v}  ← 현재` : v;
    fragment.appendChild(o);
  });
  sel.appendChild(fragment);
}

/* 파일명 */
function hhmmFromTimeStr(t){ return (t||'').replace(':',''); }
function rebuildFileName(){
  const mode   = state.mode;
  const key    = document.getElementById('selRoomTable').value;
  const tno    = key ? key.split('|')[1] : '';
  const picked = document.getElementById('selTime').value;
  const hhmm   = hhmmFromTimeStr( picked || (state.timeCenter||'').slice(0,5) );

  let nameForMode;
  if (mode === CONSTANTS.MODES.LEADERBOARD) {
    nameForMode = document.getElementById('lbTableLabel').value || ('Table'+tno);
  } else {
    const player = getSelectedPlayer();
    nameForMode = player ? player.player : 'Player';
  }

  google.script.run.withSuccessHandler(name=>{
    document.getElementById('fileName').value = name;
  }).soft_buildFileName(mode, hhmm, tno, nameForMode);
}

/* 숫자 유틸 */
function parseIntClean(s){ const n = Number(String(s||'').replace(/[^0-9]/g,'')); return isNaN(n)?0:Math.round(n); }
function comma(n){ return Number(n||0).toLocaleString('en-US'); }

/* 디바운싱 유틸 */
function debounce(func, delay) {
  let timer;
  return (...args) => {
    clearTimeout(timer);
    timer = setTimeout(() => func(...args), delay);
  };
}

/* 입력창 실시간 콤마 포맷 */
function formatInputWithComma(el){
  const v = parseIntClean(el.value);
  el.value = v ? comma(v) : '';
}

/* PU: BB(반올림) */
function computeBB(){
  const amt = parseIntClean(document.getElementById('stackAmt').value);
  const bb  = parseIntClean(document.getElementById('bigBlind').value);
  const res = (amt>0 && bb>0) ? Math.round(amt / bb) : '';
  document.getElementById('stackBB').value = res || '';
  document.getElementById('stackBBView').value = res ? `${res}BB` : '';
}

/* LEADERBOARD */
let lbListListenerAttached = false;
let lbTableLabelListenerAttached = false;

function buildLeaderboardList(){
  const key = document.getElementById('selRoomTable').value;
  if (!key) return;

  const arr = (state.byRoomTable[key]||[]).slice()
                .sort((a,b)=>Number(a.seat.replace('#',''))-Number(b.seat.replace('#','')));
  const list = document.getElementById('lbList');
  list.innerHTML = '';

  arr.forEach((r,i)=>{
    const row = document.createElement('div'); row.className='lb-row';
    row.innerHTML = `
      <input class="lbName" value="${(r.player||'')}" />
      <input class="lbAmt"  placeholder="칩스택(예: 4,190,000)" inputmode="numeric" />
    `;
    list.appendChild(row);
  });

  // 이벤트 위임으로 한 번만 등록
  if (!lbListListenerAttached) {
    list.addEventListener('input', (e) => {
      if (e.target.classList.contains('lbAmt')) {
        formatInputWithComma(e.target);
        rebuildPreview();
      } else if (e.target.classList.contains('lbName')) {
        rebuildPreview();
      }
    });
    lbListListenerAttached = true;
  }

  const tno = key.split('|')[1];
  const tlabel = document.getElementById('lbTableLabel');
  if(!tlabel.value) tlabel.value = 'Table'+tno;

  if (!lbTableLabelListenerAttached) {
    tlabel.addEventListener('input', rebuildFileName);
    lbTableLabelListenerAttached = true;
  }

  rebuildPreview();
  rebuildFileName();
}

function nameToInitialLastUpper(full){
  const parts = String(full||'').trim().split(/\s+/);
  if(parts.length===0 || !parts[0]) return '';
  const initial = (parts[0][0]||'').toUpperCase()+'.';
  const last = parts.slice(1).join(' ').toUpperCase();
  return last ? `${initial} ${last}` : initial;
}

// 숫자 → K/M 표기(블라인드 라벨용)
function formatKM(nStr){
  const n = parseIntClean(nStr);
  const [divisor, suffix] = n >= 1_000_000 ? [1_000_000, 'M'] : [1_000, 'K'];

  const formatted = (n / divisor).toFixed(2)
    .replace(/\.0+$/,'')
    .replace(/(\.\d)0$/,'function safeJson_(s){ try{return typeof s==='string'?JSON.parse(s||'{}'):(s||{});}catch(e){return {}} }
</script>');

  return `${formatted}${suffix}`;
}

/* 선택된 플레이어 정보 가져오기 */
function getSelectedPlayer(){
  const key = document.getElementById('selRoomTable').value;
  const seat = document.getElementById('selSeat').value;
  return findPlayerBySeat(key, seat);
}

/* ===== 데이터 재로드 ===== */
function reloadSheets(){
  setStatus('시트 정보 로딩…');
  google.script.run.withSuccessHandler(res=>{
    if(res?.ok){ state.timeCenter = res.center || ''; fillTimes(res.list||[], res.center||''); rebuildFileName(); }
    else toast('시간 목록 로딩 실패: '+(res?.error||'unknown'), false);
    setStatus('준비됨');
  }).soft_getTimeOptions(state.cueId || null);

  google.script.run.withSuccessHandler(res=>{
    if(res?.ok){ state.typeRows = res.rows||[]; indexTypeRows(state.typeRows); fillRoomTables(); }
    else toast('Type 탭 로딩 실패: '+(res?.error||'unknown'), false);
  }).soft_getTypeRows(state.typeId || null);
}

  /* 미리보기(전부 대문자 출력) */
function rebuildPreview(){
  const mode = state.mode;

  // DOM 요소 캐싱
  const els = {
    stackAmt: document.getElementById('stackAmt'),
    stackBB: document.getElementById('stackBB'),
    selPrize: document.getElementById('selPrize'),
    lbLevel: document.getElementById('lbLevel'),
    lbSB: document.getElementById('lbSB'),
    lbBB: document.getElementById('lbBB'),
    lbAnte: document.getElementById('lbAnte'),
    preview: document.getElementById('preview')
  };

  let body='';

  if(mode===CONSTANTS.MODES.PU){
    computeBB();
    const player = getSelectedPlayer();
    if (!player) { body = ''; }
    else {
      const name = (player.player || '').toUpperCase();
      const country = (player.nat || '').toUpperCase();
      const amt = (els.stackAmt.value||'').toUpperCase();
      const bb = (els.stackBB.value||'').toUpperCase();
      body = `${name} / ${country}\nCURRENT STACK - ${amt} (${bb}BB)`;
    }
  }else if(mode===CONSTANTS.MODES.ELIM){
    const player = getSelectedPlayer();
    if (!player) { body = ''; }
    else {
      const name = (player.player || '').toUpperCase();
      const country = (player.nat || '').toUpperCase();

      if (els.selPrize.value === 'prize') {
        const place = (document.getElementById('prizePlace').value || '').trim();
        const amount = (document.getElementById('prizeAmount').value || '').trim();
        const prizeText = place && amount ? `ELIMINATED IN ${place}TH PLACE (${amount})` : 'ELIMINATED';
        body = `${name} / ${country}\n${prizeText}`;
      } else {
        body = `${name} / ${country}\nELIMINATED`;
      }
    }
  }else if(mode===CONSTANTS.MODES.L3){
    const player = getSelectedPlayer();
    if (!player) { body = ''; }
    else {
      const name = (player.player || '').toUpperCase();
      body = `프로필 자막\n${name}`;
    }
  }else if(mode===CONSTANTS.MODES.LEADERBOARD){
    const level = (els.lbLevel.value||'').trim();
    const sb    = comma(parseIntClean(els.lbSB.value));
    const bb    = comma(parseIntClean(els.lbBB.value));
    const ante  = comma(parseIntClean(els.lbAnte.value));
    const rows = [];
    document.querySelectorAll('#lbList .lb-row').forEach(r=>{
      const name = r.querySelector('.lbName').value;
      const amt  = r.querySelector('.lbAmt').value;
      const chips = parseIntClean(amt);
      if(chips>0) rows.push({name, amt: comma(chips)});
    });
    rows.sort((a,b)=>parseInt(b.amt.replace(/,/g,'')) - parseInt(a.amt.replace(/,/g,'')));
    const lines = rows.map(o => `${nameToInitialLastUpper(o.name)}    ${o.amt}`.toUpperCase());
    const footer = `LV ${String(level||'').toUpperCase()} | BLINDS ${formatKM(sb)} / ${formatKM(bb)} - ${formatKM(ante)}`;
    body = lines.join('\n') + (lines.length?'\n\n':'') + footer;
  }
  els.preview.value = body;
}

// 현재 입력 미리보기 생성
function generateCurrentPreview() {
  const mode = state.mode;
  const els = {
    stackAmt: document.getElementById('stackAmt'),
    stackBB: document.getElementById('stackBB'),
    selPrize: document.getElementById('selPrize'),
    lbLevel: document.getElementById('lbLevel'),
    lbSB: document.getElementById('lbSB'),
    lbBB: document.getElementById('lbBB'),
    lbAnte: document.getElementById('lbAnte')
  };

  let body = '';

  if (mode === CONSTANTS.MODES.PU) {
    computeBB();
    const player = getSelectedPlayer();
    if (player) {
      const name = (player.player || '').toUpperCase();
      const country = (player.nat || '').toUpperCase();
      const amt = (els.stackAmt.value || '').toUpperCase();
      const bb = (els.stackBB.value || '').toUpperCase();
      body = `${name} / ${country}\nCURRENT STACK - ${amt} (${bb}BB)`;
    }
  } else if (mode === CONSTANTS.MODES.ELIM) {
    const player = getSelectedPlayer();
    if (player) {
      const name = (player.player || '').toUpperCase();
      const country = (player.nat || '').toUpperCase();
      if (els.selPrize.value === 'prize') {
        const place = (document.getElementById('prizePlace').value || '').trim();
        const amount = (document.getElementById('prizeAmount').value || '').trim();
        const prizeText = place && amount ? `ELIMINATED IN ${place}TH PLACE (${amount})` : 'ELIMINATED';
        body = `${name} / ${country}\n${prizeText}`;
      } else {
        body = `${name} / ${country}\nELIMINATED`;
      }
    }
  } else if (mode === CONSTANTS.MODES.L3) {
    const player = getSelectedPlayer();
    if (player) {
      const name = (player.player || '').toUpperCase();
      body = `프로필 자막\n${name}`;
    }
  } else if (mode === CONSTANTS.MODES.LEADERBOARD) {
    const level = (els.lbLevel.value || '').trim();
    const sb = comma(parseIntClean(els.lbSB.value));
    const bb = comma(parseIntClean(els.lbBB.value));
    const ante = comma(parseIntClean(els.lbAnte.value));
    const rows = [];
    document.querySelectorAll('#lbList .lb-row').forEach(r => {
      const name = r.querySelector('.lbName').value;
      const amt = r.querySelector('.lbAmt').value;
      const chips = parseIntClean(amt);
      if (chips > 0) rows.push({ name, amt: comma(chips) });
    });
    rows.sort((a, b) => parseInt(b.amt.replace(/,/g, '')) - parseInt(a.amt.replace(/,/g, '')));
    const lines = rows.map(o => `${nameToInitialLastUpper(o.name)}    ${o.amt}`.toUpperCase());
    const footer = `LV ${String(level || '').toUpperCase()} | BLINDS ${formatKM(sb)} / ${formatKM(bb)} - ${formatKM(ante)}`;
    body = lines.join('\n') + (lines.length ? '\n\n' : '') + footer;
  }

  return body;
}

// 미리보기 통합 업데이트
function updateBatchPreview() {
  const previewEl = document.getElementById('preview');
  const previewLabel = document.getElementById('previewLabel');

  if (state.batch.length > 0) {
    // 배치 모드: 배치 전체 내용 + 현재 입력 표시
    const batchContent = state.batch.map(item => item.content).join('\n\n');
    const currentPreview = generateCurrentPreview();

    previewLabel.textContent = `미리보기 (배치 ${state.batch.length}건 + 현재 입력)`;
    previewEl.value = `=== 배치 전송될 내용 (${state.batch.length}건) ===\n\n${batchContent}\n\n=== 현재 입력 (배치에 추가하려면 [➕ 배치에 추가] 클릭) ===\n\n${currentPreview}`;
  } else {
    // 단일 모드
    previewLabel.textContent = '미리보기';
    rebuildPreview();
  }
}

  /* ===== 배치 빌더 (스마트 통합) ===== */

// 스마트 전송 버튼 업데이트
function updateSendButton() {
  const btnSend = document.getElementById('btnSend');
  const btnAddToBatch = document.getElementById('btnAddToBatch');
  const batchSection = document.getElementById('batchSection');

  if (state.batch.length > 0) {
    // 배치 모드
    btnSend.innerHTML = `📤 배치 전송 (${state.batch.length}건)`;
    batchSection.style.display = 'block';
  } else {
    // 단일 모드
    btnSend.innerHTML = '전송';
    batchSection.style.display = 'none';
  }

  // 배치 추가 버튼은 LEADERBOARD 모드가 아닐 때 항상 표시
  btnAddToBatch.style.display = (state.mode === CONSTANTS.MODES.LEADERBOARD) ? 'none' : 'block';
}

// 배치에 추가
function addToBatch() {
  const preview = document.getElementById('preview').value.trim();

  if (!preview) {
    toast('미리보기가 비어있습니다. 먼저 플레이어를 선택하고 정보를 입력하세요.', false);
    return;
  }

  const player = getSelectedPlayer();
  const mode = state.mode;

  state.batch.push({
    mode,
    player: player?.player || 'Unknown',
    seat: player?.seat || '',
    nat: player?.nat || '',
    content: preview
  });

  renderBatchList();
  updateBatchPreview();
  updateSendButton();
  toast(`✅ 배치에 추가됨 (${state.batch.length}건)`, true);

  moveToNextSeat();
}

// 배치 리스트 렌더링
function renderBatchList() {
  const list = document.getElementById('batchList');

  if (state.batch.length === 0) {
    list.innerHTML = '';
    document.getElementById('batchCount').textContent = '0';
    return;
  }

  list.innerHTML = '';

  state.batch.forEach((item, idx) => {
    const div = document.createElement('div');
    div.style.cssText = 'background:var(--panel); padding:14px; border-radius:12px; display:flex; justify-content:space-between; align-items:center; margin-bottom:10px; min-height:44px;';

    div.innerHTML = `
      <div style="flex:1; min-width:0;">
        <div style="font-weight:600; font-size:0.95em;">
          ${idx + 1}. ${item.seat} ${item.player}
          <span style="color:var(--accent); margin-left:8px; font-size:0.85em;">[${item.mode}]</span>
        </div>
        <div class="muted" style="font-size:0.8em; margin-top:4px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">
          ${item.content.replace(/\n/g, ' · ').substring(0, 60)}...
        </div>
      </div>
      <button class="btn ghost" data-idx="${idx}" style="padding:10px 16px; height:auto; font-size:0.85em; margin-left:10px; flex-shrink:0;">
        삭제
      </button>
    `;

    div.querySelector('button').addEventListener('click', (e) => {
      const idx = parseInt(e.target.dataset.idx);
      state.batch.splice(idx, 1);
      renderBatchList();
      updateBatchPreview();
      updateSendButton();
      toast('항목 삭제됨', true);
    });

    list.appendChild(div);
  });

  document.getElementById('batchCount').textContent = state.batch.length;
}

// 다음 좌석으로 자동 이동
function moveToNextSeat() {
  const key = document.getElementById('selRoomTable').value;
  const seat = document.getElementById('selSeat').value;
  const arr = state.byRoomTable[key] || [];

  const seats = [...new Set(arr.map(r => normSeat(r.seat)))]
    .sort((a,b) => Number(a.replace('#','')) - Number(b.replace('#','')));

  const currentIndex = seats.indexOf(seat);

  if (currentIndex >= 0 && currentIndex < seats.length - 1) {
    const nextSeat = seats[currentIndex + 1];
    document.getElementById('selSeat').value = nextSeat;
    applyPickFromSeat();
    rebuildPreview();
    rebuildFileName();
  } else {
    if (seats.length > 0) {
      document.getElementById('selSeat').value = seats[0];
      applyPickFromSeat();
      rebuildPreview();
      rebuildFileName();
    }
  }
}

// 배치 전송
function sendBatch() {
  if (state.batch.length === 0) {
    toast('배치가 비어있습니다.', false);
    return;
  }

  const jBlock = state.batch.map(item => item.content).join('\n\n');

  const autoNow = document.getElementById('chkAuto').checked;
  const picked = document.getElementById('selTime').value;
  const timeStr = autoNow ? state.timeCenter.slice(0,5) : picked;
  const hhmm = hhmmFromTimeStr(timeStr);
  const filename = `${hhmm}_Batch_${state.batch.length}items`;

  const payload = {
    autoNow,
    pickedTime: picked,
    tz: state.tz,
    kind: 'BATCH',
    eFix: '미완료',
    gFix: 'SOFT',
    filename,
    jBlock,
    cueId: state.cueId || undefined
  };

  setStatus('전송 중…');

  google.script.run
    .withSuccessHandler(res => {
      if (!res?.ok) {
        toast('❌ 전송 실패: ' + (res?.error || 'unknown'), false);
        setStatus('에러');
        return;
      }

      toast(`✅ 배치 전송 완료! ${state.batch.length}건이 행 ${res.row}(${res.time})에 저장되었습니다.`, true);
      setStatus('준비됨');

      state.batch = [];
      renderBatchList();
      updateBatchPreview();
      updateSendButton();
    })
    .withFailureHandler(err => {
      toast('❌ 서버 오류: ' + (err?.message || err), false);
      setStatus('에러');
    })
    .soft_updateVirtual(payload);
}

/* 스마트 전송 (단일/배치 자동 감지) */
function send(){
  // 배치 모드인지 확인
  if (state.batch.length > 0) {
    sendBatch();
    return;
  }

  // 단일 전송
  sendSingle();
}

// 단일 전송
function sendSingle() {
  const autoNow = document.getElementById('chkAuto').checked;
  const picked  = document.getElementById('selTime').value;
  const filename= document.getElementById('fileName').value.trim();
  const jBlock  = generateCurrentPreview(); // 배치 미리보기 제외

  if(!jBlock){ toast('미리보기 내용이 비었습니다.', false); return; }
  if(!filename){ toast('파일명 비어있음.', false); return; }
  if(state.mode===CONSTANTS.MODES.PU){
    if(!parseIntClean(document.getElementById('stackAmt').value) || !parseIntClean(document.getElementById('bigBlind').value)){
      toast('칩스택/빅블을 입력하세요.', false); return;
    }
  }
  if(state.mode===CONSTANTS.MODES.LEADERBOARD){
    const ok = !!document.getElementById('lbLevel').value.trim()
      && parseIntClean(document.getElementById('lbSB').value)>0
      && parseIntClean(document.getElementById('lbBB').value)>0
      && parseIntClean(document.getElementById('lbAnte').value)>0
      && Array.from(document.querySelectorAll('#lbList .lbAmt')).some(i=>parseIntClean(i.value)>0);
    if(!ok){ toast('레벨/SB/BB/ANTE 및 칩스택을 입력하세요.', false); return; }
  }
  if(state.mode===CONSTANTS.MODES.ELIM){
    const prizeValue = document.getElementById('selPrize').value;
    if(prizeValue === 'prize'){
      const place = document.getElementById('prizePlace').value.trim();
      const amount = document.getElementById('prizeAmount').value.trim();
      if(!place || !amount){
        toast('순위와 상금을 입력하세요.', false); return;
      }
    }
  }

  setStatus('전송 중…');
  google.script.run.withSuccessHandler(res=>{
    if(!res?.ok){ toast('실패: '+(res?.error||'unknown'), false); setStatus('에러'); return; }
    toast(`행 ${res.row}(${res.time}) 갱신 완료`);
    setStatus('준비됨');
  }).withFailureHandler(err=>{
    toast('서버 오류: '+(err?.message||err), false);
    setStatus('에러');
  }).soft_updateVirtual({
    autoNow,
    pickedTime: picked,
    tz: state.tz,
    kind: state.mode,
    eFix: '미완료',
    gFix: 'SOFT',
    filename,
    jBlock,
    cueId: state.cueId || undefined
  });
}

  // 모드 변경
function setMode(m){
  state.mode = m;
  document.getElementById('tabPU').classList.toggle('active', m===CONSTANTS.MODES.PU);
  document.getElementById('tabELIM').classList.toggle('active', m===CONSTANTS.MODES.ELIM);
  document.getElementById('tabL3').classList.toggle('active', m===CONSTANTS.MODES.L3);
  document.getElementById('tabLB').classList.toggle('active', m===CONSTANTS.MODES.LEADERBOARD);

  document.getElementById('panelPU').style.display   = (m===CONSTANTS.MODES.PU)?CONSTANTS.DISPLAY.BLOCK:CONSTANTS.DISPLAY.NONE;
  document.getElementById('panelELIM').style.display = (m===CONSTANTS.MODES.ELIM)?CONSTANTS.DISPLAY.BLOCK:CONSTANTS.DISPLAY.NONE;
  document.getElementById('panelL3').style.display   = (m===CONSTANTS.MODES.L3)?CONSTANTS.DISPLAY.BLOCK:CONSTANTS.DISPLAY.NONE;
  document.getElementById('panelLB').style.display   = (m===CONSTANTS.MODES.LEADERBOARD)?CONSTANTS.DISPLAY.BLOCK:CONSTANTS.DISPLAY.NONE;

  const showSingle = (m!==CONSTANTS.MODES.LEADERBOARD);
  document.getElementById('singleFields').style.display= showSingle ? CONSTANTS.DISPLAY.GRID : CONSTANTS.DISPLAY.NONE;

  // 배치 작업 중 모드 변경 시 피드백
  if (state.batch.length > 0) {
    const modeNames = {
      PU: '스택 업데이트',
      ELIM: '탈락 정보',
      L3: '프로필 자막',
      LEADERBOARD: '리더보드'
    };
    toast(`⚠️ 모드 변경: ${modeNames[m]}`, true);
  }

  if(m===CONSTANTS.MODES.LEADERBOARD) buildLeaderboardList();
  rebuildPreview();
  rebuildFileName();
  updateSendButton();  // 모드 변경 시 버튼 상태 업데이트
}

  function init(){
  google.script.run.withSuccessHandler(info=>{
    state.tz = info?.tz || 'Asia/Seoul';
    document.getElementById('footerInfo').textContent =
      `기본 CUE: ${info?.cueId}  |  기본 TYPE: ${info?.typeId}  |  TZ=${state.tz}`;
    setStatus('준비됨');
  }).soft_getBootstrap();

  loadIdsFromLocal();
  reloadSheets();

  document.getElementById('btnSaveIds').onclick = saveIds;
  document.getElementById('btnClearIds').onclick = clearIds;

  document.getElementById('tabPU').onclick   = ()=>setMode(CONSTANTS.MODES.PU);
  document.getElementById('tabELIM').onclick = ()=>setMode(CONSTANTS.MODES.ELIM);
  document.getElementById('tabL3').onclick   = ()=>setMode(CONSTANTS.MODES.L3);
  document.getElementById('tabLB').onclick   = ()=>setMode(CONSTANTS.MODES.LEADERBOARD);
  document.getElementById('btnSend').onclick = send;

  // 배치 추가 버튼
  document.getElementById('btnAddToBatch').addEventListener('click', addToBatch);

  // 배치 전체 삭제
  document.getElementById('btnClearBatch').addEventListener('click', () => {
    if (state.batch.length === 0) return;

    if (confirm(`${state.batch.length}개 항목을 모두 삭제하시겠습니까?`)) {
      state.batch = [];
      renderBatchList();
      updateBatchPreview();
      updateSendButton();
      toast('배치 초기화됨', true);
    }
  });

  // 키보드 단축키: Ctrl+B
  document.addEventListener('keydown', (e) => {
    if ((e.ctrlKey || e.metaKey) && e.key === 'b') {
      e.preventDefault();
      if (state.batch.length > 0 || document.getElementById('btnAddToBatch').style.display !== 'none') {
        addToBatch();
      }
    }
  });

  document.getElementById('selRoomTable').addEventListener('change', fillSeats);
  document.getElementById('selSeat').addEventListener('change', applyPickFromSeat);

  // 디바운싱된 미리보기 갱신
  const debouncedRebuild = debounce(() => {
    rebuildPreview();
    rebuildFileName();
  }, CONSTANTS.DEBOUNCE_DELAY);

  const stackAmt = document.getElementById('stackAmt');
  stackAmt.addEventListener('input', ()=>{ formatInputWithComma(stackAmt); computeBB(); debouncedRebuild(); });
  const bigBlind = document.getElementById('bigBlind');
  bigBlind.addEventListener('input', ()=>{ formatInputWithComma(bigBlind); computeBB(); debouncedRebuild(); });

  // ELIM 모드: 상금 여부에 따라 입력란 표시/숨김
  document.getElementById('selPrize').addEventListener('change', (e) => {
    const prizeDetails = document.getElementById('prizeDetails');
    prizeDetails.style.display = e.target.value === 'prize' ? CONSTANTS.DISPLAY.BLOCK : CONSTANTS.DISPLAY.NONE;
    rebuildPreview();
  });

  // ELIM 모드: 순위/상금 입력 시 미리보기 갱신
  document.getElementById('prizePlace').addEventListener('input', debouncedRebuild);
  document.getElementById('prizeAmount').addEventListener('input', debouncedRebuild);

  setMode(CONSTANTS.MODES.ELIM);
}

// window.load 제거됨 (탭 진입시 초기화)



/* ========== 모드 전환 추가 ========== */
document.addEventListener('DOMContentLoaded', () => {
  const modeTracker = document.getElementById('modeTracker');
  const modeSoft = document.getElementById('modeSoftSender');

  if (modeTracker) {
    modeTracker.onclick = () => setMode('tracker');
  }
  if (modeSoft) {
    modeSoft.onclick = () => setMode('softsender');
  }
});

// setMode 함수 확장
const originalSetMode = setMode;
function setMode(m) {
  const panels = ['record', 'review', 'tracker', 'softsender', 'settings'];
  const buttons = ['modeRecord', 'modeReview', 'modeTracker', 'modeSoftSender', 'modeSettings'];

  panels.forEach(p => {
    const el = document.getElementById('panel' + p.charAt(0).toUpperCase() + p.slice(1));
    if (el) el.classList.add('hidden');
  });

  buttons.forEach(b => {
    const el = document.getElementById(b);
    if (el) el.classList.remove('btnPrimary');
  });

  const targetPanel = document.getElementById('panel' + m.charAt(0).toUpperCase() + m.slice(1));
  const targetBtn = document.getElementById('mode' + m.charAt(0).toUpperCase() + m.slice(1));

  if (targetPanel) targetPanel.classList.remove('hidden');
  if (targetBtn) targetBtn.classList.add('btnPrimary');

  // Tracker 모드 진입 시 초기화
  if (m === 'tracker' && typeof loadKeyPlayers === 'function') {
    loadKeyPlayers();
  }

  // SoftSender 모드 진입 시 초기화 (중복 방지)
  if (m === 'softsender' && typeof init === 'function' && !window.softSenderInitialized) {
    init();
    window.softSenderInitialized = true;
  }
}
</script>
</body>
</html>
